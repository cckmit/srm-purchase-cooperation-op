<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.srm.purchasecooperation.cux.sinv.infra.mapper.SinvRcvTrxHeaderAddAsnStatusMapper">
    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap id="BaseResultMap" type="org.srm.purchasecooperation.sinv.domain.entity.SinvRcvTrxHeader">
        <result column="rcv_trx_header_id" property="rcvTrxHeaderId" jdbcType="DECIMAL"/>
        <result column="tenant_id" property="tenantId" jdbcType="DECIMAL"/>
        <result column="supplier_tenant_id" property="supplierTenantId" jdbcType="DECIMAL"/>
        <result column="trx_num" property="trxNum" jdbcType="VARCHAR"/>
        <result column="display_trx_num" property="displayTrxNum" jdbcType="VARCHAR"/>
        <result column="trx_year" property="trxYear" jdbcType="DECIMAL"/>
        <result column="company_id" property="companyId" jdbcType="DECIMAL"/>
        <result column="company_name" property="companyName" jdbcType="VARCHAR"/>
        <result column="ou_id" property="ouId" jdbcType="DECIMAL"/>
        <result column="purchase_org_id" property="purchaseOrgId" jdbcType="DECIMAL"/>
        <result column="trx_date" property="trxDate" jdbcType="DATE"/>
        <result column="receipt_num" property="receiptNum" jdbcType="VARCHAR"/>
        <result column="receipt_header_date" property="receiptHeaderDate" jdbcType="DATE"/>
        <result column="process_flag" property="processFlag" jdbcType="DECIMAL"/>
        <result column="process_date" property="processDate" jdbcType="DATE"/>
        <result column="need_process_flag" property="needProcessFlag" jdbcType="DECIMAL"/>
        <result column="supplier_id" property="supplierId" jdbcType="DECIMAL"/>
        <result column="supplier_num" property="supplierNum" jdbcType="VARCHAR"/>
        <result column="supplier_name" property="supplierName" jdbcType="VARCHAR"/>
        <result column="supplier_site_id" property="supplierSiteId" jdbcType="DECIMAL"/>
        <result column="supplier_company_id" property="supplierCompanyId" jdbcType="DECIMAL"/>
        <result column="supplier_company_name" property="supplierCompanyName" jdbcType="VARCHAR"/>
        <result column="supplier_ou_id" property="supplierOuId" jdbcType="DECIMAL"/>
        <result column="erp_creation_date" property="erpCreationDate" jdbcType="DATE"/>
        <result column="erp_last_update_date" property="erpLastUpdateDate" jdbcType="DATE"/>
        <result column="approved_date" property="approvedDate" jdbcType="DATE"/>
        <result column="receive_amount" property="receiveAmount" jdbcType="DECIMAL"/>
        <result column="init_flag" property="initFlag" jdbcType="DECIMAL"/>
        <result column="quantity_check_flag" property="quantityCheckFlag" jdbcType="DECIMAL"/>
        <result column="source_code" property="sourceCode" jdbcType="VARCHAR"/>
        <result column="external_system_code" property="externalSystemCode" jdbcType="VARCHAR"/>
        <result column="sync_response_status" property="syncResponseStatus" jdbcType="VARCHAR"/>
        <result column="sync_response_msg" property="syncResponseMsg" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="object_version_number" property="objectVersionNumber" jdbcType="DECIMAL"/>
        <result column="creation_date" property="creationDate" jdbcType="DATE"/>
        <result column="created_by" property="createdBy" jdbcType="DECIMAL"/>
        <result column="last_updated_by" property="lastUpdatedBy" jdbcType="DECIMAL"/>
        <result column="last_update_date" property="lastUpdateDate" jdbcType="DATE"/>
    </resultMap>

    <sql id="ExpandColumnList">
        srtl.attribute_varchar1,
        srtl.attribute_varchar2,
        srtl.attribute_varchar3,
        srtl.attribute_varchar4,
        srtl.attribute_varchar5,
        srtl.attribute_varchar6,
        srtl.attribute_varchar7,
        srtl.attribute_varchar8,
        srtl.attribute_varchar9,
        srtl.attribute_varchar10,
        srtl.attribute_varchar11,
        srtl.attribute_varchar12,
        srtl.attribute_varchar13,
        srtl.attribute_varchar14,
        srtl.attribute_varchar15,
        srtl.attribute_varchar16,
        srtl.attribute_varchar17,
        srtl.attribute_varchar18,
        srtl.attribute_varchar19,
        srtl.attribute_varchar20,
        srtl.attribute_varchar21,
        srtl.attribute_varchar22,
        srtl.attribute_varchar23,
        srtl.attribute_varchar24,
        srtl.attribute_varchar25,
        srtl.attribute_varchar26,
        srtl.attribute_varchar27,
        srtl.attribute_varchar28,
        srtl.attribute_varchar29,
        srtl.attribute_varchar30,
        srtl.attribute_varchar31,
        srtl.attribute_varchar32,
        srtl.attribute_varchar33,
        srtl.attribute_varchar34,
        srtl.attribute_varchar35,
        srtl.attribute_varchar36,
        srtl.attribute_varchar37,
        srtl.attribute_varchar38,
        srtl.attribute_varchar39,
        srtl.attribute_varchar40,
        srtl.attribute_longtext1,
        srtl.attribute_longtext2,
        srtl.attribute_longtext3,
        srtl.attribute_longtext4,
        srtl.attribute_longtext5,
        srtl.attribute_longtext6,
        srtl.attribute_longtext7,
        srtl.attribute_longtext8,
        srtl.attribute_longtext9,
        srtl.attribute_longtext10,
        srtl.attribute_bigint1,
        srtl.attribute_bigint2,
        srtl.attribute_bigint3,
        srtl.attribute_bigint4,
        srtl.attribute_bigint5,
        srtl.attribute_bigint6,
        srtl.attribute_bigint7,
        srtl.attribute_bigint8,
        srtl.attribute_bigint9,
        srtl.attribute_bigint10,
        srtl.attribute_bigint11,
        srtl.attribute_bigint12,
        srtl.attribute_bigint13,
        srtl.attribute_bigint14,
        srtl.attribute_bigint15,
        srtl.attribute_bigint16,
        srtl.attribute_bigint17,
        srtl.attribute_bigint18,
        srtl.attribute_bigint19,
        srtl.attribute_bigint20,
        srtl.attribute_bigint21,
        srtl.attribute_bigint22,
        srtl.attribute_bigint23,
        srtl.attribute_bigint24,
        srtl.attribute_bigint25,
        srtl.attribute_bigint26,
        srtl.attribute_bigint27,
        srtl.attribute_bigint28,
        srtl.attribute_bigint29,
        srtl.attribute_bigint30,
        srtl.attribute_tinyint1,
        srtl.attribute_tinyint2,
        srtl.attribute_tinyint3,
        srtl.attribute_tinyint4,
        srtl.attribute_tinyint5,
        srtl.attribute_tinyint6,
        srtl.attribute_tinyint7,
        srtl.attribute_tinyint8,
        srtl.attribute_tinyint9,
        srtl.attribute_tinyint10,
        srtl.attribute_tinyint11,
        srtl.attribute_tinyint12,
        srtl.attribute_tinyint13,
        srtl.attribute_tinyint14,
        srtl.attribute_tinyint15,
        srtl.attribute_tinyint16,
        srtl.attribute_tinyint17,
        srtl.attribute_tinyint18,
        srtl.attribute_tinyint19,
        srtl.attribute_tinyint20,
        srtl.attribute_decimal1,
        srtl.attribute_decimal2,
        srtl.attribute_decimal3,
        srtl.attribute_decimal4,
        srtl.attribute_decimal5,
        srtl.attribute_decimal6,
        srtl.attribute_decimal7,
        srtl.attribute_decimal8,
        srtl.attribute_decimal9,
        srtl.attribute_decimal10,
        srtl.attribute_decimal11,
        srtl.attribute_decimal12,
        srtl.attribute_decimal13,
        srtl.attribute_decimal14,
        srtl.attribute_decimal15,
        srtl.attribute_decimal16,
        srtl.attribute_decimal17,
        srtl.attribute_decimal18,
        srtl.attribute_decimal19,
        srtl.attribute_decimal20,
        srtl.attribute_decimal21,
        srtl.attribute_decimal22,
        srtl.attribute_decimal23,
        srtl.attribute_decimal24,
        srtl.attribute_decimal25,
        srtl.attribute_decimal26,
        srtl.attribute_decimal27,
        srtl.attribute_decimal28,
        srtl.attribute_decimal29,
        srtl.attribute_decimal30,
        srtl.attribute_datetime1,
        srtl.attribute_datetime2,
        srtl.attribute_datetime3,
        srtl.attribute_datetime4,
        srtl.attribute_datetime5,
        srtl.attribute_datetime6,
        srtl.attribute_datetime7,
        srtl.attribute_datetime8,
        srtl.attribute_datetime9,
        srtl.attribute_datetime10,
        srtl.attribute_datetime11,
        srtl.attribute_datetime12,
        srtl.attribute_datetime13,
        srtl.attribute_datetime14,
        srtl.attribute_datetime15,
        srtl.attribute_datetime16,
        srtl.attribute_datetime17,
        srtl.attribute_datetime18,
        srtl.attribute_datetime19,
        srtl.attribute_datetime20,
        srtl.attribute_date1,
        srtl.attribute_date2,
        srtl.attribute_date3,
        srtl.attribute_date4,
        srtl.attribute_date5,
        srtl.attribute_date6,
        srtl.attribute_date7,
        srtl.attribute_date8,
        srtl.attribute_date9,
        srtl.attribute_date10,
        srtl.attribute_date11,
        srtl.attribute_date12,
        srtl.attribute_date13,
        srtl.attribute_date14,
        srtl.attribute_date15,
        srtl.attribute_date16,
        srtl.attribute_date17,
        srtl.attribute_date18,
        srtl.attribute_date19,
        srtl.attribute_date20
    </sql>

    <!-- 查询收货执行左边树状数据 -->
    <select id="selectSinvRcvTrxTreeList" resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxTreeDTO">
        SELECT
        sinv_v.tenant_id,
        sinv_v.node_config_id,
        sinv_v.node_config_code,
        sinv_v.node_config_name,
        sinv_v.node_config_index,
        sinv_v.reverse_enable,
        (
        SELECT
        count( 1 )
        FROM
        sinv_rcv_strategy_permission srsp3
        LEFT JOIN sinv_rcv_strategy_line srsl3 ON srsp3.strategy_line_id = srsl3.strategy_line_id
        WHERE srsl3.tenant_id = #{tenantId}
        AND srsl3.node_config_id = sinv_v.node_config_id
        AND srsp3.strategy_permission_type = 'QUERY'
        <!-- 角色权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND srsp3.role_id = #{customUserDetails.roleId}
        </if>
        ) query_count,
        (
        SELECT
        count( 1 )
        FROM
        sinv_rcv_strategy_permission srsp4
        LEFT JOIN sinv_rcv_strategy_line srsl4 ON srsp4.strategy_line_id = srsl4.strategy_line_id
        WHERE srsl4.tenant_id = #{tenantId}
        AND srsl4.node_config_id = sinv_v.node_config_id
        AND srsp4.strategy_permission_type = 'UPDATE'
        <!-- 角色权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND srsp4.role_id = #{customUserDetails.roleId}
        </if>
        ) update_count,
        (
        SELECT
        count( 1 )
        FROM
        sinv_rcv_trx_line srtl
        JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
        JOIN sinv_rcv_trx_header srth ON srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        JOIN sinv_rcv_strategy_line srsl ON srrsm.next_strategy_line_id = srsl.strategy_line_id
        LEFT JOIN sodr_po_header sph ON srto.from_po_header_id = sph.po_header_id
        WHERE
        srtl.tenant_id = #{tenantId}
        and srth.source_code = 'SRM'
        AND srtl.complete_flag = 0
        AND srsl.srm_enable = 1
        AND srtl.delete_flag = 0
        AND srsl.node_config_id = sinv_v.node_config_id
        /*不为变更中的订单*/
        AND (sph.changing_flag != 1 or srrsm.order_type_code = 'PC')
        AND (srrsm.initial_node_flag = 1
        OR EXISTS ( SELECT 1 FROM sinv_rcv_trx_line srtl1 WHERE srtl1.rcv_trx_line_id = srtl.from_rcv_trx_line_id AND
        srth.rcv_status_code = '40_FINISHED' ))
        <!-- 角色权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND EXISTS ( SELECT 1 FROM sinv_rcv_strategy_permission srsp WHERE srsp.strategy_line_id = srsl.strategy_line_id
            AND srsp.strategy_permission_type IN ( 'UPDATE', 'QUERY' ) AND srsp.role_id = #{customUserDetails.roleId})
        </if>
        <if test="sinvRcvTrxQueryDTO.allSource != null">
            <bind name="allSourceLike" value="'%' + sinvRcvTrxQueryDTO.allSource + '%'"/>
            and concat( srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0') ) like #{allSourceLike}
        </if>
        <!-- 验收人标识:采购申请行上-目前项目:叮咚买菜 -->
        <if test="sinvRcvTrxQueryDTO.accepterUserIdFlag != null">
            AND EXISTS (SELECT 1 FROM sprm_pr_line sprl
            LEFT JOIN sodr_po_line spl ON sprl.pr_line_id = spl.pr_line_id
            WHERE spl.po_line_id = srto.from_po_line_id
            and sprl.accepter_user_id = #{customUserDetails.userId})
        </if>
        <!-- 委外收货标识 -->
        <if test="sinvRcvTrxQueryDTO.thirdPartyFlag != null">
            and EXISTS (SELECT 1 FROM sinv_asn_header sah
            JOIN hpfm_company hc on sah.carriers_code = hc.company_num
            JOIN iam_user su on hc.tenant_id = su.organization_id
            WHERE hc.tenant_id = su.organization_id
            AND sah.asn_header_id =  srto.from_asn_header_id
            AND su.id = #{customUserDetails.userId})
        </if>
        ) waiting_count,
        (
        SELECT
        count( 1 )
        FROM
        sinv_rcv_trx_header srth
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        WHERE
        srth.tenant_id = #{tenantId}
        and srth.source_code = 'SRM'
        AND srsl.node_config_id = sinv_v.node_config_id
        AND srth.rcv_status_code IN ( '10_NEW', '20_SUBMITTED', '30_REJECTED' )
        AND EXISTS ( SELECT 1 FROM sinv_rcv_trx_line srtl WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id AND
        srtl.from_rcv_trx_line_id IS NOT NULL )
        <!-- 角色权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND EXISTS ( SELECT 1 FROM sinv_rcv_strategy_permission srsp
            WHERE srsp.strategy_line_id = srsl.strategy_line_id
            AND srsp.strategy_permission_type IN ( 'UPDATE', 'QUERY' )
            AND srsp.role_id = #{customUserDetails.roleId})
        </if>
        <if test="sinvRcvTrxQueryDTO.allSource != null">
            <bind name="allSourceLike" value="'%' + sinvRcvTrxQueryDTO.allSource + '%'"/>
            and EXISTS (select 1 from (select
            srtl.rcv_trx_header_id,concat(srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0'))
            as all_source
            from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id
            = srto.order_link_id) exists_v where exists_v.rcv_trx_header_id =
            srth.rcv_trx_header_id and exists_v.all_source like #{allSourceLike})
        </if>
        <!-- 委外收货标识 -->
        <if test="sinvRcvTrxQueryDTO.thirdPartyFlag != null">
            AND EXISTS (SELECT 1 FROM
            sinv_rcv_trx_line srtl
            JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
            JOIN sinv_asn_header sah ON srto.from_asn_header_id = sah.asn_header_id
            JOIN hpfm_company hc ON sah.carriers_code = hc.company_num
            JOIN iam_user su ON hc.tenant_id = su.organization_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
            and su.id = #{customUserDetails.userId})
        </if>
        <!-- 验收人标识:采购申请行上-目前项目:叮咚买菜 -->
        <if test="sinvRcvTrxQueryDTO.accepterUserIdFlag != null">
            AND EXISTS (SELECT 1 FROM sprm_pr_line sprl
            LEFT JOIN sodr_po_line spl ON sprl.pr_line_id = spl.pr_line_id
            LEFT JOIN sinv_rcv_trx_order_link srto ON spl.po_line_id = srto.from_po_line_id
            LEFT JOIN sinv_rcv_trx_line srtl ON srto.order_link_id = srtl.order_link_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
            and sprl.accepter_user_id = #{customUserDetails.userId})
        </if>
        ) doing_count,
        (
        SELECT count(1)
        FROM
        sinv_rcv_trx_line srtl
        JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
        JOIN sinv_rcv_trx_header srth ON srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        WHERE
        srtl.tenant_id = #{tenantId}
        and srth.source_code = 'SRM'
        AND srsl.node_config_id = sinv_v.node_config_id
        AND srtl.reverse_flag = 0
        AND srtl.delete_flag = 0
        AND (srrsm.initial_node_flag =1 or EXISTS ( SELECT 1 FROM sinv_rcv_trx_line srtl1
        WHERE srtl1.rcv_trx_line_id = srtl.from_rcv_trx_line_id
        AND srth.rcv_status_code = '40_FINISHED' ))
        <!-- 角色权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND EXISTS ( SELECT 1 FROM sinv_rcv_strategy_permission srsp
            WHERE srsp.strategy_line_id = srsl.strategy_line_id
            AND srsp.strategy_permission_type in ('UPDATE','QUERY')
            AND srsp.role_id = #{customUserDetails.roleId})
        </if>
        <if test="sinvRcvTrxQueryDTO.allSource != null">
            <bind name="allSourceLike" value="'%' + sinvRcvTrxQueryDTO.allSource + '%'"/>
            and concat( srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0') ) like #{allSourceLike}
        </if>
        <!-- 委外收货标识 -->
        <if test="sinvRcvTrxQueryDTO.thirdPartyFlag != null">
            and EXISTS (SELECT 1 FROM sinv_asn_header sah
            JOIN hpfm_company hc on sah.carriers_code = hc.company_num
            JOIN iam_user su on hc.tenant_id = su.organization_id
            WHERE hc.tenant_id = su.organization_id
            AND sah.asn_header_id =  srto.from_asn_header_id
            AND su.id = #{customUserDetails.userId})
        </if>
        <!-- 委外收货标识 -->
        <if test="sinvRcvTrxQueryDTO.thirdPartyFlag != null">
            and EXISTS (SELECT 1 FROM sinv_asn_header sah
            JOIN hpfm_company hc on sah.carriers_code = hc.company_num
            JOIN iam_user su WHERE
            hc.tenant_id = su.organization_id
            AND sah.asn_header_id =  srto.from_asn_header_id
            AND su.id = #{customUserDetails.userId})
        </if>
        <!-- 验收人标识:采购申请行上-目前项目:叮咚买菜 -->
        <if test="sinvRcvTrxQueryDTO.accepterUserIdFlag != null">
            AND EXISTS (SELECT 1 FROM sprm_pr_line sprl
            LEFT JOIN sodr_po_line spl ON sprl.pr_line_id = spl.pr_line_id
            WHERE spl.po_line_id = srto.from_po_line_id
            and sprl.accepter_user_id = #{customUserDetails.userId})
        </if>
        ) finished_count
        FROM
        (
        SELECT DISTINCT
        srnc.tenant_id,
        srnc.node_config_id,
        srnc.node_config_code,
        srnc.node_config_name,
        srnc.node_config_index,
        srnc.reverse_enable
        FROM
        sinv_rcv_node_config srnc
        WHERE
        srnc.tenant_id = #{tenantId}
        AND srnc.node_order_type != 'ASN'
        <!-- 角色权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND EXISTS (
            SELECT 1 FROM sinv_rcv_strategy_permission srsp
            LEFT JOIN sinv_rcv_strategy_line srsl ON srsp.strategy_line_id = srsl.strategy_line_id
            WHERE srsl.node_config_id = srnc.node_config_id
            AND srsl.node_config_id = srnc.node_config_id
            AND srsp.strategy_permission_type IN ( 'UPDATE', 'QUERY')
            AND srsp.role_id = #{customUserDetails.roleId})
        </if>
        ) sinv_v
        ORDER BY sinv_v.node_config_index ASC
    </select>

    <!-- 查询 待执行数据 -->
    <select id="selectSinvRcvTrxWainting" resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxWaitingDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        spll.need_by_date,
        spll.promise_delivery_date,
        srtl.rcv_trx_line_id,
        srtl.rcv_trx_header_id,
        sph.display_po_num,
        sph.po_num,
        concat(srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0')) as all_source,
        concat(srto.source_header_num,IFNULL(srth.trx_num,'0'),IFNULL(srto.from_display_po_num,'0')) as all_source_header,
        srtl.tenant_id,
        (case when srrsm.initial_node_flag = 1 then srto.source_header_num else srth.trx_num end ) trx_num,
        (case when srrsm.initial_node_flag = 1 then srto.source_header_num else srth.display_trx_num end )
        display_trx_num,
        (case when srrsm.initial_node_flag = 1 then srto.source_line_num else srtl.trx_line_num end ) trx_line_num,
        sah.asn_type_code,
        (case when srrsm.initial_node_flag = 1 then srrsm.order_type_code else
        srnc2.node_config_name end ) order_type_code,
        (case when srrsm.initial_node_flag = 1 and srrsm.order_type_code = 'ASN' then srto.from_display_po_num else
        srto.source_header_num end ) source_header_num,
        (case when srrsm.initial_node_flag = 1 and srrsm.order_type_code = 'ASN' then srto.from_display_po_line_num else
        srto.source_line_num end ) source_line_num,
        srtl.item_id,
        srtl.item_code,
        srtl.item_name,
        ( srtl.quantity - srtl.occupied_quantity + srtl.reversed_quantity) quantity,
        srtl.quantity org_quantity,
        ( srtl.quantity - srtl.occupied_quantity + srtl.reversed_quantity) left_quantity,
        /*当前执行金额*/
        ( srtl.tax_included_amount - srtl.occupied_tax_amount + srtl.reversed_tax_amount) tax_included_amount,
        /*不含税单价*/
        srtl.net_price,
        /*可前执行金额*/
        srtl.po_unit_price,
        srtl.tax_included_price,
        srtl.occupied_quantity,
        srtl.reversed_quantity,
        srtl.occupied_tax_amount,
        srtl.reversed_tax_amount,
        ( srtl.tax_included_amount - srtl.occupied_tax_amount + srtl.reversed_tax_amount) left_tax_amount,
        /*实际操作日期*/
        srtl.trx_date,
        /*库房*/
        hi.inventory_name,
        /*库位*/
        hl.location_name,
        /*收货组织*/
        hio.organization_name,
        /*单据数量*/
        NULL source_quantity,
        /*单位*/
        CONCAT( CONCAT( su.uom_code, '/' ), sut.uom_name ) uom_name,
        /*商品编码*/
        spl.product_num,
        spl.product_name,
        /*妥投时间*/
        sal.deliver_time due_date,
        /*供应商*/
        srth.supplier_id,
        (case when srth.supplier_num is null then hcc.company_num else srth.supplier_num end) supplier_num,
        (case when srth.supplier_name is null then srth.supplier_company_name else srth.supplier_name end)
        supplier_name,
        srth.supplier_company_id,
        /*业务实体*/
        hou.ou_name ,
        hc.company_id,
        hc.company_num,
        hc.company_name,
        srto.from_po_header_id,
        srto.from_po_line_id,
        srto.from_po_line_location_id,
        srto.from_display_po_num,
        srto.from_display_po_line_num,
        srto.from_display_po_line_location_num,
        srto.from_asn_header_id,
        srto.from_asn_line_id,
        srto.from_display_asn_num,
        srto.from_display_asn_line_num,
        srto.from_pc_header_id,
        srto.from_pc_subject_id,
        srto.from_pc_num,
        srto.from_pc_subject_num,
        srsl.strategy_header_id,
        srrsm.initial_node_flag,
        srrsm.strategy_line_id,
        srrsm.next_strategy_line_id,
        srsl.subject_type,
        srtl.inventory_id,
        srtl.locator_id,
        srsl.line_seq,
        srsl.node_config_id,
        srsl.strategy_line_id srsl_strategy_line_id,
        /*节点index*/
        srnc.node_config_index,
        /*节点编码*/
        srnc.node_config_code,
        /*节点名称*/
        srnc.node_config_name,
        srtl.object_version_number,
        srem.mapping_id as rcv_trx_type_id,
        srem.rcv_type_code,
        srem.rcv_type_name,
        srto.order_link_id,
        srtl.tax_rate,
        concat(srsh.strategy_code, '-', srsh.strategy_name) strategy_code,
        srth.rcv_status_code,
        srth.created_by,
        srtl.currency_code,
        (case when spl.unit_price_batch is null then 1 else spl.unit_price_batch end) unit_price_batch,
        srtl.move_reason,
        srto.from_pc_stage_id,
        srpd.stage_code,
        srpd.stage_name,
        srpd.check_type check_type_code,
        srpd.pay_ratio,
        srpd.pc_status_code,
        srpd.specifications,
        srpd.model,
        srpd.accepter_user_id,
        srpd.accepter_user_name,
        srtl.category_id,
        sah.carriers_code,
        sah.carriers_name,
        spl.pr_header_id,
        spl.pr_line_id,
        sah.carriers_name,
        srtl.agent_id,
        hpa.purchase_agent_name,
        sah.asn_status
        FROM
        sinv_rcv_trx_line srtl
        JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
        JOIN sinv_rcv_trx_header srth ON srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.next_strategy_line_id = srsl.strategy_line_id
        LEFT JOIN sinv_rcv_strategy_header srsh ON srsl.strategy_header_id = srsh.node_strategy_id
        LEFT JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        LEFT JOIN hpfm_inventory hi ON srtl.inventory_id = hi.inventory_id
        LEFT JOIN hpfm_location hl ON srtl.locator_id = hl.location_id
        LEFT JOIN hpfm_inv_organization hio ON srtl.inv_organization_id = hio.organization_id
        LEFT JOIN smdm_uom su ON srtl.uom_id = su.uom_id
        LEFT JOIN smdm_uom_tl sut ON su.uom_id = sut.uom_id AND sut.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON srtl.ou_id = hou.ou_id
        LEFT JOIN hpfm_company hc ON srth.company_id = hc.company_id
        LEFT JOIN hpfm_company hcc ON srth.supplier_company_id = hcc.company_id
        LEFT JOIN sinv_rcv_ext_mapping srem ON srtl.rcv_trx_type_id = srem.mapping_id
        LEFT JOIN sinv_rcv_trx_line srtl2 on srtl.from_rcv_trx_line_id = srtl2.rcv_trx_line_id
        LEFT JOIN sinv_asn_line sal on srto.from_asn_line_id = sal.asn_line_id
        LEFT JOIN sinv_asn_header sah on sal.asn_header_id = sah.asn_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl2 ON srrsm.strategy_line_id = srsl2.strategy_line_id
        LEFT JOIN sinv_rcv_node_config srnc2 ON srsl2.node_config_id = srnc2.node_config_id
        LEFT JOIN sinv_rcv_pc_details srpd ON srto.order_link_id = srpd.order_link_id
        LEFT JOIN sodr_po_line_location spll on srto.from_po_line_location_id = spll.po_line_location_id
        LEFT JOIN sodr_po_line spl ON srto.from_po_line_id = spl.po_line_id
        LEFT JOIN sodr_po_header sph ON sph.po_header_id = spl.po_header_id
        left join sprm_pr_header srh on srh.pr_header_id=srtl.pr_header_id
        LEFT JOIN hpfm_purchase_agent hpa ON srtl.agent_id = hpa.purchase_agent_id
        WHERE
        srtl.tenant_id = #{sinvRcvTrxQueryDTO.tenantId}
        <if test="@org.apache.commons.collections4.CollectionUtils@isNotEmpty(sinvRcvTrxQueryDTO.asnHeaderIds)">
            AND srrsm.order_type_code = 'ASN'
            AND srto.from_asn_header_id in
            <foreach collection="sinvRcvTrxQueryDTO.asnHeaderIds" index="index" item="item" open="(" separator=","
                     close=")">
                #{item}
            </foreach>
        </if>
        /*未执行完全的事务行*/
        AND srtl.complete_flag = 0
        /*屏蔽不是srm系统内操作的*/
        and srsl.srm_enable = 1
        and srth.source_code = 'SRM'
        AND srtl.delete_flag = 0
        /*不为变更中的订单*/
        AND (sph.changing_flag != 1 or srrsm.order_type_code = 'PC')
        /*对应的上一个来源事务应该是已完成状态-或者没有上一个事务：即初始节点*/
        AND (srrsm.initial_node_flag =1 or EXISTS ( SELECT 1 FROM sinv_rcv_trx_line srtl1
        WHERE srtl1.rcv_trx_line_id = srtl.from_rcv_trx_line_id
        AND srth.rcv_status_code = '40_FINISHED' ))
        <!-- 当前节点对应的策略行id需限制当前角色必须有编辑权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND EXISTS ( SELECT 1 FROM sinv_rcv_strategy_permission srsp
            WHERE srsp.strategy_line_id = srsl.strategy_line_id
            AND srsp.strategy_permission_type in ('UPDATE','QUERY')
            AND srsp.role_id = #{customUserDetails.roleId})
        </if>
        <!-- 节点 -->
        <if test="sinvRcvTrxQueryDTO.nodeConfigId != null and sinvRcvTrxQueryDTO.nodeConfigId != ''">
            AND srsl.node_config_id = #{sinvRcvTrxQueryDTO.nodeConfigId}
        </if>
        <!-- 单据编号-事务 -->
        <if test="sinvRcvTrxQueryDTO.trxNum != null and sinvRcvTrxQueryDTO.trxNum != ''">
            <bind name="trxNumLike" value="'%' + sinvRcvTrxQueryDTO.trxNum + '%'"/>
            and concat(srto.source_header_num,IFNULL(srth.trx_num,'0'),IFNULL(srto.from_display_po_num,'0')) like #{trxNumLike}
        </if>
        <!-- 单据编号-事务 -->
        <if test="sinvRcvTrxQueryDTO.displayTrxNum != null and sinvRcvTrxQueryDTO.displayTrxNum != ''">
            <bind name="displayTrxNumLike" value="'%' + sinvRcvTrxQueryDTO.displayTrxNum + '%'"/>
            and (case when srrsm.initial_node_flag = 1 then srto.source_header_num else srth.display_trx_num end ) like #{displayTrxNumLike}
        </if>
        <!-- 单据编号 -->
        <if test="sinvRcvTrxQueryDTO.sourceHeaderNum != null and sinvRcvTrxQueryDTO.sourceHeaderNum != ''">
            <bind name="sourceHeaderNumLike" value="'%' + sinvRcvTrxQueryDTO.sourceHeaderNum + '%'"/>
            and (case when srrsm.initial_node_flag = 1 and srrsm.order_type_code = 'ASN' then srto.from_display_po_num else
            srto.source_header_num end ) like #{sourceHeaderNumLike}
        </if>
        <!-- 单据行号 -->
        <if test="sinvRcvTrxQueryDTO.sourceLineNum != null">
            <bind name="sourceLineNumLike" value="'%' + sinvRcvTrxQueryDTO.sourceLineNum + '%'"/>
            AND (case when srrsm.initial_node_flag = 1 and srrsm.order_type_code = 'ASN' then srto.from_display_po_line_num else
            srto.source_line_num end ) like #{sourceLineNumLike}
        </if>
        <!-- 物料 -->
        <if test="sinvRcvTrxQueryDTO.itemId != null and sinvRcvTrxQueryDTO.itemId != ''">
            and srtl.item_id = #{sinvRcvTrxQueryDTO.itemId}
        </if>
        <!-- 供应商 -->
        <if test="sinvRcvTrxQueryDTO.supplierCompanyId != null and sinvRcvTrxQueryDTO.supplierCompanyId != ''">
            AND srtl.supplier_company_id = #{sinvRcvTrxQueryDTO.supplierCompanyId}
        </if>
        <!-- 移动类型 -->
        <if test="sinvRcvTrxQueryDTO.rcvTrxTypeId != null and sinvRcvTrxQueryDTO.rcvTrxTypeId != ''">
            AND srem.mapping_id = #{sinvRcvTrxQueryDTO.rcvTrxTypeId}
        </if>
        <!-- 单号-物料 -->
        <if test="sinvRcvTrxQueryDTO.allSource != null">
            <bind name="allSourceLike" value="'%' + sinvRcvTrxQueryDTO.allSource + '%'"/>
            AND concat(srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0')) like #{allSourceLike}
        </if>
        <!-- 验收人标识:采购申请行上-目前项目:叮咚买菜 -->
        <if test="sinvRcvTrxQueryDTO.accepterUserIdFlag != null">
            AND EXISTS (SELECT 1 FROM sprm_pr_line sprl
            LEFT JOIN sodr_po_line spl ON sprl.pr_line_id = spl.pr_line_id
            WHERE spl.po_line_id = srto.from_po_line_id
            and sprl.accepter_user_id = #{customUserDetails.userId})
        </if>
        <!-- 事务行id -->
        <if test="sinvRcvTrxQueryDTO.rcvTrxLineIds != null">
            and srtl.rcv_trx_line_id in
            <foreach collection="sinvRcvTrxQueryDTO.rcvTrxLineIds" index="index" item="item" open="(" separator=","
                     close=")">
                #{item}
            </foreach>
        </if>
        <!-- 委外收货标识 -->
        <if test="sinvRcvTrxQueryDTO.thirdPartyFlag != null">
            and EXISTS (SELECT 1 FROM hpfm_company hc
            JOIN iam_user su WHERE
            hc.tenant_id = su.organization_id
            AND su.id = #{customUserDetails.userId}
            AND hc.company_num = sah.carriers_code)
        </if>
        <!-- sap订单号 -->
        <if test="sinvRcvTrxQueryDTO.displayPoNum != null and sinvRcvTrxQueryDTO.displayPoNum != ''">
            <bind name="displayPoNumLike" value="'%' + sinvRcvTrxQueryDTO.displayPoNum + '%'"/>
            and sph.display_po_num like #{displayPoNumLike}
        </if>
        <!-- 订单号 -->
        <if test="sinvRcvTrxQueryDTO.poNum != null and sinvRcvTrxQueryDTO.poNum != ''">
            <bind name="poNumLike" value="'%' + sinvRcvTrxQueryDTO.poNum + '%'"/>
            and sph.po_num like #{poNumLike}
        </if>
        <!-- 事务日期 -->
        <if test = "sinvRcvTrxQueryDTO.trxDateStart != null">
            AND srtl.trx_date &gt;= #{sinvRcvTrxQueryDTO.trxDateStart}
        </if>
        <if test = "sinvRcvTrxQueryDTO.trxDateEnd != null">
            AND srtl.trx_date &lt; #{sinvRcvTrxQueryDTO.trxDateEnd}
        </if>

        <!-- 发运行需求日期 -->
        <if test="sinvRcvTrxQueryDTO.needByDateStart != null">
            AND spll.need_by_date &gt;= #{sinvRcvTrxQueryDTO.needByDateStart}
        </if>
        <if test="sinvRcvTrxQueryDTO.needByDateEnd != null">
            AND spll.need_by_date &lt;= #{sinvRcvTrxQueryDTO.needByDateEnd}
        </if>

        <!-- 发运行承诺交货日期 -->
        <if test="sinvRcvTrxQueryDTO.promiseDeliveryDateStart != null">
            AND spll.promise_delivery_date &gt;= #{sinvRcvTrxQueryDTO.promiseDeliveryDateStart}
        </if>
        <if test="sinvRcvTrxQueryDTO.promiseDeliveryDateEnd != null">
            AND spll.promise_delivery_date &lt; #{sinvRcvTrxQueryDTO.promiseDeliveryDateEnd}
        </if>

        order by rcv_trx_line_id desc
    </select>

    <!-- 查询 收货执行-获取执行中数据 -->
    <select id="selectSinvRcvTrxDoing" resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxDoingDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srth.rcv_trx_header_id,
        /*建议策略id*/
        null sug_strategy_line_id,
        /*备注*/
        srth.remark,
        srth.rcv_status_code,
        /*单据类型*/
        srrsm.order_type_code,
        /**srrsm.order_type_name,*/
        srnc.node_config_name order_type_name,
        /*是否退回*/
        srth.returned_flag,
        /*单据编号*/
        srth.trx_num,
        srth.display_trx_num,
        /*供应商*/
        srth.supplier_company_id,
        srth.supplier_id,
        (case when srth.supplier_num is null then hcc.company_num else srth.supplier_num end) supplier_num,
        (case when srth.supplier_name is null then srth.supplier_company_name else srth.supplier_name end)
        supplier_name,
        hc.company_id,
        hc.company_num,
        hc.company_name,
        srth.object_version_number,
        srsl.subject_type,
        srsl.line_seq,
        srnc.node_config_id,
        /*节点index*/
        srnc.node_config_index,
        /*节点编码*/
        srnc.node_config_code,
        /*节点名称*/
        srnc.node_config_name,
        (SELECT srem.rcv_type_name FROM sinv_rcv_ext_mapping srem
            JOIN sinv_rcv_trx_line srtl ON srtl.rcv_trx_type_id = srem.mapping_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        <if test="_databaseId=='mysql'">
            limit 1
        </if>
        <if test="_databaseId=='oracle'">
            rownum = 1
        </if>) AS rcv_type_name,
        srrsm.strategy_line_id,
        srsl.strategy_header_id,
        concat(srsh.strategy_code, '-', srsh.strategy_name) strategy_code,
        srth.created_by
        FROM
        sinv_rcv_trx_header srth
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        LEFT JOIN hpfm_company hc ON srth.company_id = hc.company_id
        LEFT JOIN hpfm_company hcc ON srth.supplier_company_id = hcc.company_id
        LEFT JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        LEFT JOIN sinv_rcv_strategy_header srsh ON srsl.strategy_header_id = srsh.node_strategy_id
        WHERE
        srth.tenant_id = #{sinvRcvTrxQueryDTO.tenantId}
        and srth.source_code = 'SRM'
        and srth.rcv_status_code in ('10_NEW','20_SUBMITTED','30_REJECTED')
        /*存在来源事务*/
        and EXISTS (SELECT 1 from sinv_rcv_trx_line srtl where srtl.rcv_trx_header_id = srth.rcv_trx_header_id and
        srtl.from_rcv_trx_line_id is not null)
        /*当前节点对应的策略行id需限制当前角色必须有编辑权限*/
        <!-- 角色权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND EXISTS ( SELECT 1 FROM sinv_rcv_strategy_permission srsp
            WHERE srsp.strategy_line_id = srsl.strategy_line_id
            AND srsp.strategy_permission_type in ('UPDATE','QUERY')
            AND srsp.role_id = #{customUserDetails.roleId})
        </if>
        <!-- 节点 -->
        <if test="sinvRcvTrxQueryDTO.nodeConfigId != null and sinvRcvTrxQueryDTO.nodeConfigId != ''">
            AND srsl.node_config_id = #{sinvRcvTrxQueryDTO.nodeConfigId}
        </if>
        <!-- 单据编号-事务 -->
        <if test="sinvRcvTrxQueryDTO.trxNum != null and sinvRcvTrxQueryDTO.trxNum != ''">
            <bind name="trxNumLike" value="'%' + sinvRcvTrxQueryDTO.trxNum + '%'"/>
            and EXISTS (select 1 from (select
            srtl.rcv_trx_header_id,concat(srto.source_header_num,IFNULL(srth2.trx_num,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0'))
            as all_source
            from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_header srth2 ON  srtl.rcv_trx_header_id = srth2.rcv_trx_header_id
            JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id)
            exists_v where exists_v.rcv_trx_header_id = srth.rcv_trx_header_id
            and exists_v.all_source like #{trxNumLike})
        </if>
        <!-- 单据编号-事务 -->
        <if test="sinvRcvTrxQueryDTO.displayTrxNum != null and sinvRcvTrxQueryDTO.displayTrxNum != ''">
            <bind name="displayTrxNumLike" value="'%' + sinvRcvTrxQueryDTO.displayTrxNum + '%'"/>
            and EXISTS (select 1 from (select
            srtl.rcv_trx_header_id,concat(srto.source_header_num,IFNULL(srth2.trx_num,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0'))
            as all_source
            from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_header srth2 ON  srtl.rcv_trx_header_id = srth2.rcv_trx_header_id
            JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id)
            exists_v where exists_v.rcv_trx_header_id = srth.rcv_trx_header_id
            and exists_v.all_source like #{displayTrxNumLike})
        </if>
        <!-- 单据编号 -->
        <if test="sinvRcvTrxQueryDTO.sourceHeaderNum != null and sinvRcvTrxQueryDTO.sourceHeaderNum != ''">
            <bind name="sourceHeaderNumLike" value="'%' + sinvRcvTrxQueryDTO.sourceHeaderNum + '%'"/>
            and EXISTS (select 1 from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id
            = srto.order_link_id
            where srtl.rcv_trx_header_id = srth.rcv_trx_header_id and srto.source_header_num like
            #{sourceHeaderNumLike})
        </if>
        <!-- 单据行号 -->
        <if test="sinvRcvTrxQueryDTO.sourceLineNum != null and sinvRcvTrxQueryDTO.sourceLineNum != ''">
            <bind name="sourceLineNumLike" value="'%' + sinvRcvTrxQueryDTO.sourceLineNum + '%'"/>
            and EXISTS (select 1 from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id
            = srto.order_link_id
            where srtl.rcv_trx_header_id = srth.rcv_trx_header_id and srto.source_line_num like
            #{sourceLineNumLike})
        </if>
        <!-- 物料 -->
        <if test="sinvRcvTrxQueryDTO.itemId != null and sinvRcvTrxQueryDTO.itemId != ''">
            and EXISTS (select 1 from sinv_rcv_trx_line srtl
            where srtl.rcv_trx_header_id = srth.rcv_trx_header_id and srtl.item_id = #{sinvRcvTrxQueryDTO.itemId})
        </if>
        <!-- 供应商 -->
        <if test="sinvRcvTrxQueryDTO.supplierCompanyId != null and sinvRcvTrxQueryDTO.supplierCompanyId != ''">
            and srth.supplier_company_id = #{sinvRcvTrxQueryDTO.supplierCompanyId}
        </if>
        <!-- 单号-物料 -->
        <if test="sinvRcvTrxQueryDTO.allSource != null">
            <bind name="allSourceLike" value="'%' + sinvRcvTrxQueryDTO.allSource + '%'"/>
            and EXISTS (select 1 from (select
            srtl.rcv_trx_header_id,concat(srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0'))
            as all_source
            from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id
            = srto.order_link_id) exists_v where exists_v.rcv_trx_header_id =
            srth.rcv_trx_header_id and exists_v.all_source like #{allSourceLike})
        </if>
        <!-- 验收人标识:采购申请行上-目前项目:叮咚买菜 -->
        <if test="sinvRcvTrxQueryDTO.accepterUserIdFlag != null">
            AND EXISTS (SELECT 1 FROM sprm_pr_line sprl
            LEFT JOIN sodr_po_line spl ON sprl.pr_line_id = spl.pr_line_id
            LEFT JOIN sinv_rcv_trx_order_link srto ON spl.po_line_id = srto.from_po_line_id
            LEFT JOIN sinv_rcv_trx_line srtl ON srto.order_link_id = srtl.order_link_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
            and sprl.accepter_user_id = #{customUserDetails.userId})
        </if>
        <!-- 委外收货标识 -->
        <if test="sinvRcvTrxQueryDTO.thirdPartyFlag != null">
            AND EXISTS (SELECT 1 FROM
            sinv_rcv_trx_line srtl
            JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
            JOIN sinv_asn_header sah ON srto.from_asn_header_id = sah.asn_header_id
            JOIN hpfm_company hc ON sah.carriers_code = hc.company_num
            JOIN iam_user su ON hc.tenant_id = su.organization_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
              and su.id = #{customUserDetails.userId})
        </if>
        <!-- 事务头id -->
        <if test="sinvRcvTrxQueryDTO.rcvTrxHeaderIds != null">
            and srth.rcv_trx_header_id in
            <foreach collection="sinvRcvTrxQueryDTO.rcvTrxHeaderIds" index="index" item="item" open="(" separator=","
                     close=")">
                #{item}
            </foreach>
        </if>
        order by srth.rcv_trx_header_id desc
    </select>

    <!-- 查询 已完成-整单查询 -->
    <select id="selectSinvRcvTrxFinishHeader"
            resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxFinishHeaderDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srth.rcv_trx_header_id,
        /*建议策略id*/
        null sug_strategy_line_id,
        /*备注*/
        srth.remark,
        srth.rcv_status_code,
        /*单据类型*/
        /**srrsm.order_type_code,
        srrsm.order_type_name,*/
        srnc.node_config_name order_type_name,
        /*是否退回*/
        srth.returned_flag,
        /*单据编号*/
        srth.trx_num,
        srth.display_trx_num,
        /*供应商*/
        srth.supplier_id,
        (case when srth.supplier_num is null then hcc.company_num else srth.supplier_num end) supplier_num,
        (case when srth.supplier_name is null then srth.supplier_company_name else srth.supplier_name end)
        supplier_name,
        hc.company_id,
        hc.company_num,
        hc.company_name,
        srth.object_version_number,
        srsl.subject_type,
        srsl.line_seq,
        srnc.node_config_id,
        /*节点index*/
        srnc.node_config_index,
        /*节点编码*/
        srnc.node_config_code,
        /*节点名称*/
        srnc.node_config_name,
        (SELECT srem.rcv_type_name FROM sinv_rcv_ext_mapping srem
            JOIN sinv_rcv_trx_line srtl ON srtl.rcv_trx_type_id = srem.mapping_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        <if test="_databaseId=='mysql'">
            limit 1
        </if>
        <if test="_databaseId=='oracle'">
            rownum = 1
        </if>) AS rcv_type_name,
        concat(srsh.strategy_code, '-', srsh.strategy_name) strategy_code,
        srth.created_by
        FROM
        sinv_rcv_trx_header srth
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        /*查询采购事务头状态为已完成且（关联事务事务头策略行映射表）策略行id为当前传入节点所对应的策略行id的所有事务头*/
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        LEFT JOIN hpfm_company hc ON srth.company_id = hc.company_id
        LEFT JOIN hpfm_company hcc ON srth.supplier_company_id = hcc.company_id
        LEFT JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        LEFT JOIN sinv_rcv_strategy_header srsh ON srsl.strategy_header_id = srsh.node_strategy_id
        WHERE
        srth.tenant_id = #{sinvRcvTrxQueryDTO.tenantId}
        <!-- 事务头id -->
        <if test="sinvRcvTrxQueryDTO.rcvTrxHeaderIds != null">
            and srth.rcv_trx_header_id in
            <foreach collection="sinvRcvTrxQueryDTO.rcvTrxHeaderIds" index="index" item="item" open="(" separator=","
                     close=")">
                #{item}
            </foreach>
        </if>
        and srth.source_code = 'SRM'
        AND srth.rcv_status_code = '40_FINISHED'
        /*当前节点对应的策略行id需限制当前角色必须有编辑权限*/
        <!-- 角色权限 -->
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND EXISTS ( SELECT 1 FROM sinv_rcv_strategy_permission srsp
            WHERE srsp.strategy_line_id = srsl.strategy_line_id
            AND srsp.strategy_permission_type in ('UPDATE','QUERY')
            AND srsp.role_id = #{customUserDetails.roleId})
        </if>
        <!-- 节点 -->
        <if test="sinvRcvTrxQueryDTO.nodeConfigId != null and sinvRcvTrxQueryDTO.nodeConfigId != ''">
            AND srsl.node_config_id = #{sinvRcvTrxQueryDTO.nodeConfigId}
        </if>
        <!-- 单据编号-事务 -->
        <if test="sinvRcvTrxQueryDTO.trxNum != null and sinvRcvTrxQueryDTO.trxNum != ''">
            <bind name="trxNumLike" value="'%' + sinvRcvTrxQueryDTO.trxNum + '%'"/>
            and EXISTS (select 1 from (select
            srtl.rcv_trx_header_id,concat(srto.source_header_num,IFNULL(srth2.trx_num,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0'))
            as all_source
            from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_header srth2 ON  srtl.rcv_trx_header_id = srth2.rcv_trx_header_id
            JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id)
            exists_v where exists_v.rcv_trx_header_id = srth.rcv_trx_header_id
            and exists_v.all_source like #{trxNumLike})
        </if>
        <!-- 单据编号-事务 -->
        <if test="sinvRcvTrxQueryDTO.displayTrxNum != null and sinvRcvTrxQueryDTO.displayTrxNum != ''">
            <bind name="displayTrxNumLike" value="'%' + sinvRcvTrxQueryDTO.displayTrxNum + '%'"/>
            and EXISTS (select 1 from (select
            srtl.rcv_trx_header_id,concat(srto.source_header_num,IFNULL(srth2.trx_num,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0'))
            as all_source
            from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_header srth2 ON  srtl.rcv_trx_header_id = srth2.rcv_trx_header_id
            JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id)
            exists_v where exists_v.rcv_trx_header_id = srth.rcv_trx_header_id
            and exists_v.all_source like #{displayTrxNumLike})
        </if>
        <!-- 单据编号 -->
        <if test="sinvRcvTrxQueryDTO.sourceHeaderNum != null and sinvRcvTrxQueryDTO.sourceHeaderNum != ''">
            <bind name="sourceHeaderNumLike" value="'%' + sinvRcvTrxQueryDTO.sourceHeaderNum + '%'"/>
            and EXISTS (select 1 from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id
            = srto.order_link_id
            where srtl.rcv_trx_header_id = srth.rcv_trx_header_id and srto.source_header_num like
            #{sourceHeaderNumLike})
        </if>
        <!-- 单据行号 -->
        <if test="sinvRcvTrxQueryDTO.sourceLineNum != null and sinvRcvTrxQueryDTO.sourceLineNum != ''">
            <bind name="sourceLineNumLike" value="'%' + sinvRcvTrxQueryDTO.sourceLineNum + '%'"/>
            and EXISTS (select 1 from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id
            = srto.order_link_id
            where srtl.rcv_trx_header_id = srth.rcv_trx_header_id and srto.source_line_num like
            #{sourceLineNumLike})
        </if>
        <!-- 物料 -->
        <if test="sinvRcvTrxQueryDTO.itemId != null and sinvRcvTrxQueryDTO.itemId != ''">
            and EXISTS (select 1 from sinv_rcv_trx_line srtl
            where srtl.rcv_trx_header_id = srth.rcv_trx_header_id and srtl.item_id = #{sinvRcvTrxQueryDTO.itemId})
        </if>
        <!-- 供应商 -->
        <if test="sinvRcvTrxQueryDTO.supplierCompanyId != null and sinvRcvTrxQueryDTO.supplierCompanyId != ''">
            and srth.supplier_company_id = #{sinvRcvTrxQueryDTO.supplierCompanyId}
        </if>
        <!-- 单号-物料 -->
        <if test="sinvRcvTrxQueryDTO.allSource != null">
            <bind name="allSourceLike" value="'%' + sinvRcvTrxQueryDTO.allSource + '%'"/>
            and EXISTS (SELECT 1 from (select
            srtl.rcv_trx_header_id,concat(srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0'))
            as all_source
            from sinv_rcv_trx_line srtl JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id
            = srto.order_link_id) exists_v where exists_v.rcv_trx_header_id =
            srth.rcv_trx_header_id and exists_v.all_source like #{allSourceLike})
        </if>
        <!-- 验收人标识:采购申请行上-目前项目:叮咚买菜 -->
        <if test="sinvRcvTrxQueryDTO.accepterUserIdFlag != null">
            AND EXISTS (SELECT 1 FROM sprm_pr_line sprl
            LEFT JOIN sodr_po_line spl ON sprl.pr_line_id = spl.pr_line_id
            LEFT JOIN sinv_rcv_trx_order_link srto ON spl.po_line_id = srto.from_po_line_id
            LEFT JOIN sinv_rcv_trx_line srtl ON srto.order_link_id = srtl.order_link_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
            and sprl.accepter_user_id = #{customUserDetails.userId})
        </if>
        <!-- 委外收货标识 -->
        <if test="sinvRcvTrxQueryDTO.thirdPartyFlag != null">
            AND EXISTS (SELECT 1 FROM
            sinv_rcv_trx_line srtl
            JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
            JOIN sinv_asn_header sah ON srto.from_asn_header_id = sah.asn_header_id
            JOIN hpfm_company hc ON sah.carriers_code = hc.company_num
            JOIN iam_user su ON hc.tenant_id = su.organization_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
            and su.id = #{customUserDetails.userId})
        </if>
        order by srth.rcv_trx_header_id desc

    </select>

    <!-- 查询 已完成-按行查询 -->
    <select id="selectSinvRcvTrxFinishLine"
            resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxFinishLineDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srtl.rcv_trx_line_id,
        srtl.rcv_trx_header_id,
        sph.display_po_num,
        sph.po_num,
        concat(srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0')) as all_source,
        srtl.tenant_id,
        (case when srrsm.initial_node_flag = 1 then srto.source_header_num else srth.trx_num end ) trx_num,
        (case when srrsm.initial_node_flag = 1 then srto.source_header_num else srth.display_trx_num end )
        display_trx_num,
        (case when srrsm.initial_node_flag = 1 then srto.source_line_num else srtl.trx_line_num end ) trx_line_num,
        srrsm.order_type_code,
        (case when srrsm.initial_node_flag = 1 then srrsm.order_type_name else srnc.node_config_name end )
        order_type_name,
        concat(srto.source_header_num,IFNULL(srth.trx_num,'0'),IFNULL(srto.from_display_po_num,'0')) as all_source_header,
        srto.source_header_num,
        srto.source_line_num,
        srtl.item_id,
        srtl.item_code,
        srtl.item_name,
        /*单据数量*/
        srtl.quantity,
        /*本次退回*/
        (srtl.quantity - srtl.occupied_quantity + srtl.reversed_quantity) update_quantity,
        (srtl.tax_included_amount - srtl.occupied_tax_amount + srtl.reversed_tax_amount) update_tax_amount,
        /*可退回数量*/
        (srtl.quantity - srtl.occupied_quantity + srtl.reversed_quantity) left_quantity,
        /*修改时记录修改前的数量*/
        srtl.quantity org_quantity,
        /*退回数量*/
        srtl.reversed_quantity,
        /*占用数量*/
        srtl.occupied_quantity,
        /*当前执行金额*/
        srtl.net_amount,
        /*不含税单价*/
        srtl.net_price,
        srtl.po_unit_price,
        srtl.tax_included_price,
        srtl.occupied_tax_amount,
        srtl.reversed_tax_amount,
        srtl.tax_included_amount,
        (srtl.tax_included_amount - srtl.occupied_tax_amount + srtl.reversed_tax_amount) left_tax_amount,
        /*实际操作日期*/
        srtl.trx_date,
        /*库房*/
        hi.inventory_name,
        /*库位*/
        hl.location_name,
        /*收货组织*/
        hio.organization_name,
        /*单据数量*/
        spll.quantity source_quantity,
        /*单位*/
        CONCAT( CONCAT( su.uom_code, '/' ), sut.uom_name ) uom_name,
        /*商品编码*/
        spl.product_num,
        spl.product_name,
        /*妥投时间*/
        sal.deliver_time due_date,
        /*供应商*/
        srth.supplier_id,
        (case when srth.supplier_num is null then hcc.company_num else srth.supplier_num end) supplier_num,
        (case when srth.supplier_name is null then srth.supplier_company_name else srth.supplier_name end)
        supplier_name,
        /*业务实体*/
        hou.ou_name ,
        hc.company_id,
        hc.company_num,
        hc.company_name,
        srto.from_po_header_id,
        srto.from_po_line_id,
        srto.from_po_line_location_id,
        srto.from_display_po_num,
        srto.from_display_po_line_num,
        srto.from_display_po_line_location_num,
        srto.from_asn_header_id,
        srto.from_asn_line_id,
        srto.from_display_asn_num,
        srto.from_display_asn_line_num,
        srto.from_pc_header_id,
        srto.from_pc_subject_id,
        srto.from_pc_num,
        srto.from_pc_subject_num,
        srsl.strategy_header_id,
        srrsm.initial_node_flag,
        srrsm.strategy_line_id,
        srtl.inventory_id,
        srtl.locator_id,
        srtl.object_version_number,
        srsl.subject_type,
        srsl.line_seq,
        srnc.node_config_id,
        /*节点index*/
        srnc.node_config_index,
        /*节点编码*/
        srnc.node_config_code,
        /*节点名称*/
        srnc.node_config_name,
        srem.rcv_type_name,
        srtl.from_rcv_trx_line_id,
        srtl.rcv_trx_line_id parent_trx_line_id,
        srtl.rcv_trx_type_id,
        srto.order_link_id,
        srtl.tax_rate,
        concat(srsh.strategy_code, '-', srsh.strategy_name) strategy_code,
        srth.rcv_status_code,
        srtl.currency_code,
        (case when spl.unit_price_batch is null then 1 else spl.unit_price_batch end) unit_price_batch,
        srtl.move_reason,
        sah.carriers_code,
        srpd.stage_code,
        srpd.stage_name,
        srpd.check_type check_type_code,
        srpd.pay_ratio,
        srpd.pc_status_code,
        srpd.specifications,
        srpd.model,
        srpd.accepter_user_id,
        srpd.accepter_user_name,
        srtl.category_id
        FROM
        sinv_rcv_trx_line srtl
        JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
        JOIN sinv_rcv_trx_header srth ON srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        LEFT JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        LEFT JOIN hpfm_inventory hi ON srtl.inventory_id = hi.inventory_id
        LEFT JOIN hpfm_location hl ON srtl.locator_id = hl.location_id
        LEFT JOIN hpfm_inv_organization hio ON srtl.inv_organization_id = hio.organization_id
        LEFT JOIN smdm_uom su ON srtl.uom_id = su.uom_id
        LEFT JOIN smdm_uom_tl sut ON su.uom_id = sut.uom_id AND sut.lang = #{lang}
        LEFT JOIN hpfm_operation_unit hou ON srtl.ou_id = hou.ou_id
        LEFT JOIN hpfm_company hc ON srth.company_id = hc.company_id
        LEFT JOIN hpfm_company hcc ON srth.supplier_company_id = hcc.company_id
        LEFT JOIN sodr_po_line_location spll on srto.from_po_line_location_id = spll.po_line_location_id
        LEFT JOIN sodr_po_line spl ON srto.from_po_line_id = spl.po_line_id
        LEFT JOIN sodr_po_header sph ON sph.po_header_id = spll.po_header_id
        LEFT JOIN sinv_rcv_ext_mapping srem ON srtl.rcv_trx_type_id = srem.mapping_id
        LEFT JOIN sinv_asn_line sal on srto.from_asn_line_id = sal.asn_line_id
        LEFT JOIN sinv_asn_header sah on sal.asn_header_id = sah.asn_header_id
        LEFT JOIN sinv_rcv_strategy_header srsh ON srsl.strategy_header_id = srsh.node_strategy_id
        LEFT JOIN sinv_rcv_pc_details srpd ON srto.order_link_id = srpd.order_link_id
        left join sprm_pr_header srh on srh.pr_header_id=srtl.pr_header_id
        WHERE
        srtl.tenant_id = #{sinvRcvTrxQueryDTO.tenantId}
        <!-- 事务行id -->
        <if test="sinvRcvTrxQueryDTO.rcvTrxLineIds != null">
            and srtl.rcv_trx_line_id in
            <foreach collection="sinvRcvTrxQueryDTO.rcvTrxLineIds" index="index" item="item" open="(" separator=","
                     close=")">
                #{item}
            </foreach>
        </if>
        and srth.source_code = 'SRM'
        AND srtl.reverse_flag = 0
        AND srtl.delete_flag = 0
        AND (srrsm.initial_node_flag =1 or EXISTS ( SELECT 1 FROM sinv_rcv_trx_line srtl1
        WHERE srtl1.rcv_trx_line_id = srtl.from_rcv_trx_line_id
        AND srth.rcv_status_code = '40_FINISHED' ))
        <!-- 角色权限 -->
        /*当前节点对应的策略行id需限制当前角色必须有编辑权限*/
        <if test="customUserDetails.roleId != null and customUserDetails.roleId != ''">
            AND EXISTS ( SELECT 1 FROM sinv_rcv_strategy_permission srsp
            WHERE srsp.strategy_line_id = srrsm.strategy_line_id
            AND srsp.strategy_permission_type in ('UPDATE','QUERY')
            AND srsp.role_id = #{customUserDetails.roleId})
        </if>
        <!-- 节点 -->
        <if test="sinvRcvTrxQueryDTO.nodeConfigId != null and sinvRcvTrxQueryDTO.nodeConfigId != ''">
            AND srnc.node_config_id = #{sinvRcvTrxQueryDTO.nodeConfigId}
        </if>
        <!-- 单据编号-事务 -->
        <if test="sinvRcvTrxQueryDTO.trxNum != null and sinvRcvTrxQueryDTO.trxNum != ''">
            <bind name="trxNumLike" value="'%' + sinvRcvTrxQueryDTO.trxNum + '%'"/>
            and concat(srto.source_header_num,IFNULL(srth.trx_num,'0'),IFNULL(srto.from_display_po_num,'0')) like #{trxNumLike}
        </if>
        <!-- 单据编号-事务 -->
        <if test="sinvRcvTrxQueryDTO.displayTrxNum != null and sinvRcvTrxQueryDTO.displayTrxNum != ''">
            <bind name="displayTrxNumLike" value="'%' + sinvRcvTrxQueryDTO.displayTrxNum + '%'"/>
            and (case when srrsm.initial_node_flag = 1 then srto.source_header_num else srth.display_trx_num end )
            display_trx_num like #{displayTrxNumLike}
        </if>
        <!-- 单据编号 -->
        <if test="sinvRcvTrxQueryDTO.sourceHeaderNum != null and sinvRcvTrxQueryDTO.sourceHeaderNum != ''">
            <bind name="sourceHeaderNumLike" value="'%' + sinvRcvTrxQueryDTO.sourceHeaderNum + '%'"/>
            and srto.source_header_num like #{sourceHeaderNumLike}
        </if>
        <!-- 单据行号 -->
        <if test="sinvRcvTrxQueryDTO.sourceLineNum != null">
            <bind name="sourceLineNumLike" value="'%' + sinvRcvTrxQueryDTO.sourceLineNum + '%'"/>
            AND srto.source_line_num like #{sinvRcvTrxQueryDTO.sourceLineNumLike}
        </if>
        <!-- 物料 -->
        <if test="sinvRcvTrxQueryDTO.itemId != null and sinvRcvTrxQueryDTO.itemId != ''">
            and srtl.item_id = #{sinvRcvTrxQueryDTO.itemId}
        </if>
        <!-- 供应商 -->
        <if test="sinvRcvTrxQueryDTO.supplierCompanyId != null and sinvRcvTrxQueryDTO.supplierCompanyId != ''">
            AND srtl.supplier_company_id = #{sinvRcvTrxQueryDTO.supplierCompanyId}
        </if>
        <!-- 移动类型 -->
        <if test="sinvRcvTrxQueryDTO.rcvTrxTypeId != null and sinvRcvTrxQueryDTO.rcvTrxTypeId != ''">
            AND srem.mapping_id = #{sinvRcvTrxQueryDTO.rcvTrxTypeId}
        </if>
        <!-- 单号-物料 -->
        <if test="sinvRcvTrxQueryDTO.allSource != null">
            <bind name="allSourceLike" value="'%' + sinvRcvTrxQueryDTO.allSource + '%'"/>
            AND concat(srto.source_header_num,IFNULL(srtl.item_name,'0'),IFNULL(srto.from_display_po_num,'0'),IFNULL(srto.from_pc_num,'0')) like #{allSourceLike}
        </if>
        <!-- 验收人标识:采购申请行上-目前项目:叮咚买菜 -->
        <if test="sinvRcvTrxQueryDTO.accepterUserIdFlag != null">
            AND EXISTS (SELECT 1 FROM sprm_pr_line sprl
            LEFT JOIN sodr_po_line spl ON sprl.pr_line_id = spl.pr_line_id
            WHERE spl.po_line_id = srto.from_po_line_id
            and sprl.accepter_user_id = #{customUserDetails.userId})
        </if>
        <!-- 委外收货标识 -->
        <if test="sinvRcvTrxQueryDTO.thirdPartyFlag != null">
            and EXISTS (SELECT 1 FROM hpfm_company hc
            JOIN iam_user su WHERE
            hc.tenant_id = su.organization_id
            AND su.id = #{customUserDetails.userId}
            AND hc.company_num = sah.carriers_code)
        </if>
        <!-- sap订单号 -->
        <if test="sinvRcvTrxQueryDTO.displayPoNum != null and sinvRcvTrxQueryDTO.displayPoNum != ''">
            <bind name="displayPoNumLike" value="'%' + sinvRcvTrxQueryDTO.displayPoNum + '%'"/>
            and sph.display_po_num like #{displayPoNumLike}
        </if>
        <!-- 订单号 -->
        <if test="sinvRcvTrxQueryDTO.poNum != null and sinvRcvTrxQueryDTO.poNum != ''">
            <bind name="poNumLike" value="'%' + sinvRcvTrxQueryDTO.poNum + '%'"/>
            and sph.po_num like #{poNumLike}
        </if>
        <!-- 事务日期 -->
        <if test = "sinvRcvTrxQueryDTO.trxDateStart != null">
            AND srtl.trx_date &gt;= #{sinvRcvTrxQueryDTO.trxDateStart}
        </if>
        <if test = "sinvRcvTrxQueryDTO.trxDateEnd != null">
            AND srtl.trx_date &lt; #{sinvRcvTrxQueryDTO.trxDateEnd}
        </if>
        order by srtl.rcv_trx_line_id desc

    </select>

    <!-- 查询 事务头查询 -->
    <select id="selectHeaderdetail" resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxHeaderDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srth.rcv_trx_header_id,
        srth.trx_num,
        srth.display_trx_num,
        srrsm.order_type_code,
        srrsm.order_type_name,
        srrsm.strategy_line_id,
        srsl.strategy_header_id,
        concat(srsh.strategy_code, '-', srsh.strategy_name) strategy_code,
        srsh.source_order_type,
        srnc.node_config_code,
        srnc.node_config_name,
        srth.returned_flag,
        srth.company_id,
        hc.company_num,
        hc.company_name,
        srth.supplier_id,
        (case when srth.supplier_num is null then hcc.company_num else srth.supplier_num end) supplier_num,
        (case when srth.supplier_name is null then srth.supplier_company_name else srth.supplier_name end)
        supplier_name,
        hcs.company_num supplier_company_num,
        hcs.company_name supplier_company_name,
        iu.real_name creation_name,
        (SELECT srem.attachment_uuid FROM sinv_rcv_ext_mapping srem
            JOIN sinv_rcv_trx_line srtl ON srtl.rcv_trx_type_id = srem.mapping_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        <if test="_databaseId=='mysql'">
            limit 1
        </if>
        <if test="_databaseId=='oracle'">
            rownum = 1
        </if>) AS attachment_template_uuid,
        (SELECT srem.rcv_type_name FROM sinv_rcv_ext_mapping srem
            JOIN sinv_rcv_trx_line srtl ON srtl.rcv_trx_type_id = srem.mapping_id
            WHERE srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        <if test="_databaseId=='mysql'">
            limit 1
        </if>
        <if test="_databaseId=='oracle'">
            rownum = 1
        </if>) AS rcv_type_name,
        srth.creation_date,
        srth.sinv_header_attachment_uuid,
        srth.trx_date,
        srth.object_version_number,
        srth.rcv_status_code,
        srth.remark
        FROM
        sinv_rcv_trx_header srth
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        LEFT JOIN sinv_rcv_strategy_header srsh ON srsl.strategy_header_id = srsh.node_strategy_id
        LEFT JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        LEFT JOIN hpfm_company hc ON srth.company_id = hc.company_id
        LEFT JOIN hpfm_company hcc ON srth.supplier_company_id = hcc.company_id
        LEFT JOIN sslm_external_supplier es ON srth.supplier_id = es.supplier_id
        LEFT JOIN hpfm_company hcs ON hcs.company_id = srth.supplier_company_id
        LEFT JOIN iam_user iu ON srth.created_by = iu.id
        WHERE
        srth.rcv_trx_header_id = #{rcvTrxHeaderId}
        and srth.source_code = 'SRM'
        and srth.tenant_id = #{tenantId}

    </select>

    <!-- 根据发运行查询数据 -->
    <select id="sinvPoLocationToRcv" resultType="org.srm.purchasecooperation.sinv.domain.vo.InitSinvRcvTrxDataVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT NULL
        asn_Line_Id,
        spll.tenant_id,
        NULL asn_Line_Num,
        NULL display_Asn_Line_Num,
        (case when sph.display_po_num is null then sph.po_num else sph.display_po_num end) display_po_num,
        (case when sph.display_po_num is null then sph.po_num else sph.display_po_num end) from_display_po_num,
        spl.display_line_num from_display_po_line_num,
        spll.display_line_location_num from_display_po_line_location_num,
        sph.display_release_num,
        spl.line_num,
        spl.display_line_num,
        spl.remark,
        spll.display_line_location_num,
        sph.version_num,
        NULL invoice_Num,
        NULL asn_Header_Id,
        NULL asn_Num,
        NULL asn_Type_Code,
        spl.item_id,
        (case when spl.item_code is null then si.item_code else spl.item_code end) item_code,
        (case when spl.item_name is null then si.item_name else spl.item_name end) item_name,
        hi.inventory_code,
        hi.inventory_name,
        sph.ship_to_location_address,
        NULL location_Name,
        NULL location_Id,
        NULL location_Id_Copy,
        spll.po_line_location_id from_Po_Line_Location_Id,
        NULL from_Asn_Header_Id,
        NULL from_Asn_Line_Id,
        spll.inv_organization_id,
        hio.organization_code inv_organization_code,
        hio.organization_name inv_organization_name,
        spll.po_header_id from_Po_Header_Id,
        spll.po_line_id from_Po_Line_Id,
        spl.currency_code,
        spl.unit_price net_price,
        spl.entered_tax_included_price tax_included_price,
        spl.unit_price / spl.unit_price_batch po_unit_price,
        (spl.unit_price / spl.unit_price_batch*spll.quantity) net_amount,
        (spll.quantity*spl.entered_tax_included_price/spl.unit_price_batch) tax_included_amount,
        spl.tax_id,
        spl.unit_price entered_trx_price,
        (spl.unit_price / spl.unit_price_batch*spll.quantity) entered_trx_amount,
        spl.base_currency_code entered_currency_code,
        spl.rate_type,
        NULL contact_Info,
        NULL actual_Receiver_Name,
        NULL actual_Receiver_Code,
        spl.rate_date exchange_rate_date,
        NULL expected_Arrive_Date,
        NULL promised_Date,
        0 this_Time_Receive_Quantity,
        spl.rate exchange_rate,
        spl.uom_id,
        su.uom_code,
        su.uom_name,
        sph.company_id,
        sph.company_name,
        sph.ou_id,
        sph.purchase_org_id pur_organization_id,
        sph.supplier_id,
        sph.supplier_tenant_id,
        (
        CASE

        WHEN sph.supplier_id IS NOT NULL
        AND sph.supplier_code IS NOT NULL THEN
        sph.supplier_code
        WHEN sph.supplier_id IS NOT NULL
        AND sph.supplier_code IS NULL THEN
        es.supplier_num ELSE hc.company_num
        END
        ) AS supplier_num,
        (
        CASE

        WHEN sph.supplier_id IS NOT NULL
        AND sph.supplier_name IS NOT NULL THEN
        sph.supplier_name
        WHEN sph.supplier_id IS NOT NULL
        AND sph.supplier_name IS NULL THEN
        es.supplier_name ELSE hc.company_name
        END
        ) AS supplier_name,
        sph.supplier_site_id,
        sph.supplier_company_id,
        sph.supplier_company_name,
        NULL lot_Num,
        NULL shelf_Life,
        spl.brand,
        spl.specifications,
        spl.model,
        NULL lot_Expiration_Date,
        NULL production_Date,
        sph.supplier_ou_id,
        sph.terms_id,
        sph.agent_id,
        sph.agent_id po_agent_id,
        hpa.purchase_agent_code agent_code,
        hpa.purchase_agent_name agent_name,
        st.tax_rate,
        NULL ship_Quantity,
        ( spll.quantity - spll.occupied_quantity ) can_receive_quantity,
        spll.quantity AS shipped_quantity,
        NULL unit_Package_Quantity,
        NULL package_Quantity,
        NULL remainder_Quantity,
        sph.external_system_code,
        'SRM' source_Code,
        NULL from_Expected_Arrive_Date,
        NULL to_Expected_Arrive_Date,
        spl.product_num,
        spl.product_name,
        spl.catalog_name,
        spl.pr_line_id,
        sab.deliver_time,
        NULL receive_Status,
        NULL reality_Receive_Date,
        sph.receive_order_type,
        spll.po_line_location_id,
        sott.order_type_name AS po_type_code_meaning,
        sot.order_type_code AS po_type_code,
        null display_Trx_Line_Num,
        spl.returned_flag,
        sph.display_po_num source_header_num,
        spl.line_num source_line_num,
        'ORDER' source_Order_Type,
        '订单' source_Order_Type_Meaning,
        null strategy_Line_Id,
        null strategy_Header_Id,
        1 initial_node_flag,
        null from_pc_header_id,
        null from_pc_subject_id,
        null from_pc_num,
        null from_pc_subject_num,
        null rcv_trx_line_id,
        null rcv_trx_header_id,
        null trx_line_num,
        null trx_num,
        null display_trx_num,
        null from_Rcv_Trx_Line_Id,
        spll.quantity,
        spll.inv_inventory_id inventory_id,
        spll.inv_location_id locator_id,
        spl.category_id,
        (select srsm.initial_node_flag from sinv_rcv_trx_order_link srto left join sinv_rcv_trx_line srtl on
        srto.order_link_id = srtl.order_link_id
        left join sinv_rcv_record_strategy_mapping srsm on srtl.rcv_trx_header_id = srsm.rcv_trx_header_id
        where srto.tenant_id = #{tenantId}
        and srto.from_po_line_location_id = spll.po_line_location_id
        and srsm.initial_node_flag = 1
        and srtl.complete_flag = 0
        and srsm.order_type_code = 'ORDER'
        <if test="_databaseId=='mysql'">
            limit 1
        </if>
        <if test="_databaseId=='oracle'">
            rownum = 1
        </if>)
        check_initial_node_flag,
        (select srsm.initial_node_flag from sinv_rcv_trx_order_link srto left join sinv_rcv_trx_line srtl on
        srto.order_link_id = srtl.order_link_id
        left join sinv_rcv_record_strategy_mapping srsm on srtl.rcv_trx_header_id = srsm.rcv_trx_header_id
        where srto.tenant_id = #{tenantId}
        and srto.from_po_line_location_id = spll.po_line_location_id
        and srsm.initial_node_flag = 1
        and srsm.order_type_code = 'ORDER'
        <if test="_databaseId=='mysql'">
            limit 1
        </if>
        <if test="_databaseId=='oracle'">
            rownum = 1
        </if>)
        srm_check_flag,
        spl.cost_id,
        spl.pr_header_id,
        spl.pr_line_id

        FROM
        sodr_po_line_location spll
        JOIN sodr_po_line spl ON spl.po_line_id = spll.po_line_id
        JOIN sodr_po_header sph ON sph.po_header_id = spll.po_header_id
        LEFT JOIN hpfm_inventory hi ON spll.inv_inventory_id = hi.inventory_id
        LEFT JOIN hpfm_inv_organization hio ON spll.inv_organization_id = hio.organization_id
        LEFT JOIN smdm_uom su ON spl.uom_id = su.uom_id
        LEFT JOIN sslm_external_supplier es ON sph.supplier_id = es.supplier_id
        LEFT JOIN hpfm_company hc ON hc.company_id = sph.supplier_company_id
        LEFT JOIN hpfm_purchase_agent hpa ON sph.agent_id = hpa.purchase_agent_id
        LEFT JOIN smdm_tax st ON st.tax_id = spl.tax_id
        LEFT JOIN sfin_auto_bill sab ON sab.po_line_location_id = spll.po_line_location_id
        LEFT JOIN sodr_order_type sot ON sot.order_type_id = sph.po_type_id
        LEFT JOIN sodr_order_type_tl sott ON sott.order_type_id = sot.order_type_id AND sott.lang = #{lang}
        LEFT JOIN smdm_item si ON spl.item_id = si.item_id and spll.tenant_id = si.tenant_id
        WHERE
        sph.tenant_id = #{tenantId}
        AND sph.tenant_id = spl.tenant_id
        <if test="lineIds != null and lineIds.size() > 0">
            and spll.po_line_location_id in
            <foreach collection="lineIds" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        order by sph.display_po_num asc, spl.display_line_num asc
    </select>

    <select id="selectPoId" resultType="org.srm.purchasecooperation.sinv.domain.vo.SinvRcvTrxOrderLinkVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        spll.po_line_location_id from_Po_Line_Location_Id,
        spll.po_line_id from_Po_Line_Id,
        spll.po_header_id from_Po_Header_Id,
        sph.display_po_num from_Display_Po_Num,
        spl.display_line_num from_Display_Po_Line_Num
        FROM
        sodr_po_line_location spll
        JOIN sodr_po_line spl ON spl.po_line_id = spll.po_line_id
        JOIN sodr_po_header sph ON sph.po_header_id = spll.po_header_id
        WHERE
        spll.tenant_id = #{tenantId}
        AND (sph.po_num = #{sourceNum} or sph.display_po_num = #{sourceNum})
    </select>

    <select id="selectAsnId" resultType="org.srm.purchasecooperation.sinv.domain.vo.SinvRcvTrxOrderLinkVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        sal.asn_header_id from_Asn_Header_Id,
        sal.asn_line_id from_Asn_Line_Id,
        sah.asn_num from_Display_Asn_Num,
        sal.display_asn_line_num from_Display_Asn_Line_Num
        FROM
        sinv_asn_line sal
        JOIN sinv_asn_header sah ON sal.asn_header_id = sah.asn_header_id
        WHERE
        sal.tenant_id = #{tenantId}
        AND sah.asn_num = #{sourceNum}
    </select>

    <!-- 根据送货单行查询数据 -->
    <select id="sinvAsnLineToRcv" resultType="org.srm.purchasecooperation.sinv.domain.vo.InitSinvRcvTrxDataVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        sal.asn_line_id,
        sal.tenant_id,
        sal.asn_line_num,
        sal.display_asn_line_num,
        sah.asn_num from_display_asn_num,
        sal.asn_line_num from_display_asn_line_num,
        sph.display_release_num,
        spl.line_num,
        spl.display_line_num,
        spl.remark,
        spll.display_line_location_num,
        (case when sph.display_po_num is null then sph.po_num else sph.display_po_num end) display_po_num,
        (case when sph.display_po_num is null then sph.po_num else sph.display_po_num end) from_Display_Po_Num,
        spl.display_line_num from_display_po_line_num,
        spll.display_line_location_num from_display_po_line_location_num,
        sph.version_num,
        sal.invoice_num,
        sal.asn_header_id,
        sah.asn_num,
        sah.asn_type_code,
        sal.item_id,
        (case when sal.item_code is null then si.item_code else sal.item_code end) item_code,
        (case when sal.item_name is null then si.item_name else sal.item_name end) item_name,
        hi.inventory_code,
        hi.inventory_name,
        sah.ship_to_location_address,
        hl.location_name,
        sal.location_id,
        NULL location_Id_Copy,
        sal.po_line_location_id from_po_line_location_id,
        sal.asn_header_id from_asn_header_id,
        sal.asn_line_id from_asn_line_id,
        sah.inv_organization_id,
        hio.organization_name inv_organization_name,
        hio.organization_code inv_organization_code,
        spll.po_header_id from_po_header_id,
        spll.po_line_id from_po_line_id,
        spl.currency_code,
        spl.unit_price net_price,
        spl.entered_tax_included_price tax_included_price,
        spl.unit_price / spl.unit_price_batch po_unit_price,
        (sal.ship_quantity*(spl.unit_price / spl.unit_price_batch)) net_amount,
        (sal.ship_quantity*spl.entered_tax_included_price/spl.unit_price_batch) tax_included_amount,
        spl.tax_id,
        spl.unit_price entered_trx_price,
        (sal.ship_quantity*spl.unit_price/ spl.unit_price_batch) entered_trx_amount,
        spl.base_currency_code entered_currency_code,
        spl.rate_type,
        sal.contact_info,
        sah.actual_receiver_name,
        sah.actual_receiver_code,
        spl.rate_date exchange_rate_date,
        sah.expected_arrive_date,
        sal.promised_date,
        0 this_Time_Receive_Quantity,
        spl.rate exchange_rate,
        spl.uom_id,
        su.uom_code,
        su.uom_name,
        sah.company_id,
        sah.company_name,
        sah.ou_id,
        sah.purchase_org_id pur_organization_id,
        sah.supplier_id,
        sah.supplier_tenant_id,
        (
        CASE

        WHEN sph.supplier_id IS NOT NULL
        AND sph.supplier_code IS NOT NULL THEN
        sph.supplier_code
        WHEN sph.supplier_id IS NOT NULL
        AND sph.supplier_code IS NULL THEN
        es.supplier_num ELSE hc.company_num
        END
        ) AS supplier_num,
        (
        CASE

        WHEN sph.supplier_id IS NOT NULL
        AND sph.supplier_name IS NOT NULL THEN
        sph.supplier_name
        WHEN sph.supplier_id IS NOT NULL
        AND sph.supplier_name IS NULL THEN
        es.supplier_name ELSE hc.company_name
        END
        ) AS supplier_name,
        sah.supplier_site_id,
        sah.supplier_company_id,
        sah.supplier_company_name,
        sal.lot_num,
        sal.shelf_life,
        spl.brand,
        spl.specifications,
        spl.model,
        sal.lot_expiration_date,
        sal.production_date,
        sph.supplier_ou_id,
        sph.terms_id,
        sal.agent_id,
        sph.agent_id AS po_agent_id,
        hpa.purchase_agent_code agent_code,
        hpa.purchase_agent_name agent_name,
        st.tax_rate,
        sal.ship_quantity,
        ( sal.ship_quantity - sal.receive_quantity ) can_receive_quantity,
        spll.quantity AS shipped_quantity,
        sal.unit_package_quantity,
        sal.package_quantity,
        sal.remainder_quantity,
        sah.external_system_code,
        'SRM' source_Code,
        NULL from_Expected_Arrive_Date,
        NULL to_Expected_Arrive_Date,
        spl.product_num,
        spl.product_name,
        spl.catalog_name,
        spl.pr_line_id,
        sab.deliver_time,
        NULL receive_Status,
        NULL reality_Receive_Date,
        sph.receive_order_type,
        sal.po_line_location_id,
        sott.order_type_name AS po_type_code_meaning,
        sot.order_type_code AS po_type_code,
        NULL display_Trx_Line_Num,
        spl.returned_flag,
        sah.asn_num source_header_num,
        sal.asn_line_num source_line_num,
        'ASN' source_Order_Type,
        '送货单' source_Order_Type_Meaning,
        NULL strategy_Line_Id,
        NULL strategy_Header_Id,
        1 initial_node_flag,
        null from_pc_header_id,
        null from_pc_subject_id,
        null from_pc_num,
        null from_pc_subject_num,
        null rcv_trx_line_id,
        null rcv_trx_header_id,
        null trx_line_num,
        null trx_num,
        null display_trx_num,
        null from_Rcv_Trx_Line_Id,
        sal.ship_quantity quantity,
        sal.inventory_id,
        sal.location_id locator_id,
        spl.category_id,
        (select srsm.initial_node_flag from sinv_rcv_trx_order_link srto left join sinv_rcv_trx_line srtl on
        srto.order_link_id = srtl.order_link_id
        left join sinv_rcv_record_strategy_mapping srsm on srtl.rcv_trx_header_id = srsm.rcv_trx_header_id
        where srto.tenant_id = #{tenantId}
        and srto.from_asn_line_id = sal.asn_line_id
        and srsm.initial_node_flag = 1
        and srtl.complete_flag = 0
        and srsm.order_type_code = 'ASN'
        <if test="_databaseId=='mysql'">
            limit 1
        </if>
        <if test="_databaseId=='oracle'">
            rownum = 1
        </if>)
        check_initial_node_flag,
        spl.cost_id,
        spl.pr_header_id,
        spl.pr_line_id
        FROM
        sinv_asn_line sal
        JOIN sinv_asn_header sah ON sal.asn_header_id = sah.asn_header_id
        JOIN sodr_po_line_location spll ON sal.po_line_location_id = spll.po_line_location_id
        JOIN sodr_po_line spl ON spl.po_line_id = spll.po_line_id
        JOIN sodr_po_header sph ON sph.po_header_id = spll.po_header_id
        LEFT JOIN hpfm_inventory hi ON sal.inventory_id = hi.inventory_id
        LEFT JOIN hpfm_location hl ON sal.location_id = hl.location_id
        LEFT JOIN hpfm_inv_organization hio ON sah.inv_organization_id = hio.organization_id
        LEFT JOIN smdm_uom su ON spl.uom_id = su.uom_id
        LEFT JOIN sslm_external_supplier es ON sph.supplier_id = es.supplier_id
        LEFT JOIN hpfm_company hc ON hc.company_id = sah.supplier_company_id
        LEFT JOIN hpfm_purchase_agent hpa ON sal.agent_id = hpa.purchase_agent_id
        LEFT JOIN smdm_tax st ON st.tax_id = spl.tax_id
        LEFT JOIN sodr_order_type sot ON sot.order_type_id = sph.po_type_id
        LEFT JOIN sodr_order_type_tl sott ON sott.order_type_id = sot.order_type_id AND sott.lang = #{lang}
        LEFT JOIN sfin_auto_bill sab ON sab.po_line_location_id = spll.po_line_location_id
        LEFT JOIN smdm_item si ON sal.item_id = si.item_id and sal.tenant_id = si.tenant_id
        WHERE
        sal.tenant_id = #{tenantId}
        <if test="lineIds != null and lineIds.size() > 0">
            and sal.asn_line_id in
            <foreach collection="lineIds" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        order by sah.asn_num asc, sal.asn_line_num asc
    </select>

    <!-- 根据事务行查询数据 -->
    <select id="sinvToRcv" resultType="org.srm.purchasecooperation.sinv.domain.vo.InitSinvRcvTrxDataVO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srto.from_asn_line_id asn_line_id,
        srto.from_pc_subject_num,
        srto.from_display_po_num,
        srto.from_display_po_line_num,
        srto.from_display_po_line_location_num,
        srto.from_display_asn_num,
        srto.from_display_asn_line_num,
        srtl.tenant_id,
        srto.from_display_asn_line_num asn_line_num,
        srto.from_display_asn_line_num display_asn_line_num,
        sph.display_release_num,
        srto.from_display_po_line_num line_num,
        srto.from_display_po_line_num display_line_num,
        spl.remark,
        srto.from_display_po_line_location_num display_line_location_num,
        sph.version_num,
        sal.invoice_num,
        srto.from_asn_header_id asn_header_id,
        srto.from_display_asn_num asn_num,
        sah.asn_type_code,
        srtl.item_id,
        srtl.item_code,
        srtl.item_name,
        hi.inventory_code,
        hi.inventory_name,
        sph.ship_to_location_address,
        hl.location_name,
        srto.from_po_line_location_id,
        srto.from_asn_header_id,
        srto.from_asn_line_id,
        srtl.inv_organization_id,
        hio.organization_name inv_organization_name,
        hio.organization_code inv_organization_code,
        srto.from_po_header_id,
        srto.from_po_line_id,
        srtl.currency_code,
        srtl.net_price,
        srtl.tax_included_price,
        srtl.po_unit_price,
        srtl.net_amount,
        srtl.tax_included_amount,
        srtl.tax_id,
        srtl.entered_trx_price,
        srtl.entered_trx_amount,
        srtl.entered_currency_code,
        srtl.rate_type,
        sal.contact_info,
        sah.actual_receiver_name,
        sah.actual_receiver_code,
        srtl.exchange_rate_date,
        sah.expected_arrive_date,
        sal.promised_date,
        0 this_Time_Receive_Quantity,
        srtl.exchange_rate,
        srtl.uom_id,
        su.uom_code,
        su.uom_name,
        srtl.company_id,
        srtl.company_name,
        srtl.ou_id,
        srtl.pur_organization_id,
        srtl.supplier_id,
        srtl.supplier_tenant_id,
        srtl.supplier_num,
        srtl.supplier_name,
        srtl.supplier_site_id,
        srtl.supplier_company_id,
        srtl.supplier_company_name,
        srtl.lot_num,
        sal.shelf_life,
        spl.brand,
        spl.specifications,
        spl.model,
        sal.lot_expiration_date,
        sal.production_date,
        srtl.supplier_ou_id,
        srtl.terms_id,
        srtl.agent_id,
        srtl.agent_id po_agent_id,
        hpa.purchase_agent_code agent_code,
        hpa.purchase_agent_name agent_name,
        srtl.tax_rate,
        sal.ship_quantity,
        ( srtl.quantity - srtl.occupied_quantity ) can_receive_quantity,
        spll.quantity AS shipped_quantity,
        sal.unit_package_quantity,
        sal.package_quantity,
        sal.remainder_quantity,
        sah.external_system_code,
        'SRM' source_Code,
        NULL from_Expected_Arrive_Date,
        NULL to_Expected_Arrive_Date,
        spl.product_num,
        spl.product_name,
        spl.catalog_name,
        spl.pr_line_id,
        sab.deliver_time,
        NULL receive_Status,
        NULL reality_Receive_Date,
        sph.receive_order_type,
        srto.from_po_line_location_id po_line_location_id,
        sott.order_type_name AS po_type_code_meaning,
        sot.order_type_code AS po_type_code,
        srtl.display_trx_line_num,
        spl.returned_flag,
        srto.source_header_num,
        srto.source_line_num,
        srrsm.order_type_code source_Order_Type,
        ( CASE WHEN srrsm.order_type_code = 'ORDER' THEN '订单' WHEN srrsm.order_type_code = 'ASN' THEN '送货单' WHEN
        srrsm.order_type_code = 'PC' THEN '协议' ELSE '接收' END ) source_Order_Type_Meaning,
        srrsm.strategy_Line_Id,
        srsl.strategy_header_id,
        0 initial_node_flag,
        srtl.rcv_trx_line_id,
        srtl.rcv_trx_header_id,
        srtl.trx_line_num,
        srth.trx_num,
        srth.display_trx_num,
        srtl.rcv_trx_line_id from_Rcv_Trx_Line_Id,
        srtl.quantity,
        srtl.inventory_id,
        srtl.locator_id,
        srtl.rcv_trx_type_id,
        srtl.category_id,
        srto.from_pc_stage_id,
        srpd.stage_code,
        srpd.stage_name,
        srpd.check_type check_type_code,
        srpd.pay_ratio,
        srpd.pc_status_code,
        srpd.specifications,
        srpd.model,
        srpd.accepter_user_id,
        srpd.accepter_user_name,
        srto.order_link_id,
        spl.cost_id,
        spl.pr_header_id,
        spl.pr_line_id,
        <include refid="ExpandColumnList" />
        FROM
        sinv_rcv_trx_line srtl
        JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
        JOIN sinv_rcv_trx_header srth ON srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        LEFT JOIN sinv_asn_line sal ON srto.from_asn_line_id = sal.asn_line_id
        LEFT JOIN sinv_asn_header sah ON sal.asn_header_id = sah.asn_header_id
        LEFT JOIN sodr_po_line_location spll ON srto.from_po_line_location_id = spll.po_line_location_id
        LEFT JOIN sodr_po_line spl ON spl.po_line_id = spll.po_line_id
        LEFT JOIN sodr_po_header sph ON sph.po_header_id = spll.po_header_id
        LEFT JOIN hpfm_inventory hi ON srtl.inventory_id = hi.inventory_id
        LEFT JOIN hpfm_location hl ON srtl.locator_id = hl.location_id
        LEFT JOIN hpfm_inv_organization hio ON srtl.inv_organization_id = hio.organization_id
        LEFT JOIN smdm_uom su ON srtl.uom_id = su.uom_id
        LEFT JOIN hpfm_company hc ON hc.company_id = srtl.supplier_company_id
        LEFT JOIN hpfm_purchase_agent hpa ON srtl.agent_id = hpa.purchase_agent_id
        LEFT JOIN sfin_auto_bill sab ON sab.po_line_location_id = srto.from_po_line_location_id
        LEFT JOIN sodr_order_type sot ON sot.order_type_id = sph.po_type_id
        LEFT JOIN sodr_order_type_tl sott ON sott.order_type_id = sot.order_type_id AND sott.lang = #{lang}
        LEFT JOIN sinv_rcv_pc_details srpd ON srto.order_link_id = srpd.order_link_id
        WHERE
        srtl.tenant_id = #{tenantId}
        AND srtl.delete_flag = 0
        <if test="lineIds != null and lineIds.size() > 0">
            and srtl.rcv_trx_line_id in
            <foreach collection="lineIds" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        order by srrsm.order_type_code asc, srto.source_header_num asc, srto.source_line_num asc
    </select>

    <!--  根据退回节点:node_config_id 找到这个节点对应有哪些策略行 -->
    <select id="selectStrategyLineByReverseNodeConfig"
            resultType="org.srm.purchasecooperation.sinv.domain.entity.RcvStrategyLine">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srsl.strategy_line_id,
        srsl.strategy_header_id,
        srsl.line_seq,
        srsl.srm_enable,
        srsl.subject_type,
        srsl.last_strategy_line_id,
        srsl.next_strategy_line_id,
        srsl.node_config_id,
        srsl.approve_rule_code,
        srsl.export_ext_enable,
        srsl.tenant_id,
        srsl.object_version_number
        FROM
        sinv_rcv_strategy_line srsl
        LEFT JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        LEFT JOIN sinv_rcv_reverse_config srrc ON srnc.node_config_id = srrc.reverse_node_config_id
        WHERE
        srsl.tenant_id = #{tenantId}
        AND srrc.reverse_node_config_id = #{nodeConfigId}
        <if test="strategyHeaderIds != null and strategyHeaderIds.size() > 0">
            and srsl.strategy_header_id in
            <foreach collection="strategyHeaderIds" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <!-- 待行的 -->
    <select id="selectWaitingSinvRcvTrxMaxNodeConfig"
            resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxNodeTreeDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srrsm.tenant_id,
        srrsm.rcv_trx_header_id,
        #{rcvTrxLineId} rcv_trx_line_id,
        (case when srsl1.line_seq is null then srsl.line_seq else srsl1.line_seq end) line_seq
        FROM
        sinv_rcv_record_strategy_mapping srrsm
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        LEFT JOIN sinv_rcv_strategy_line srsl1 ON srrsm.next_strategy_line_id = srsl1.strategy_line_id
        WHERE
        srrsm.tenant_id = #{tenantId}
        AND srrsm.rcv_trx_header_id = #{rcvTrxHeaderId}
    </select>
    <!-- 其他三种的 -->
    <select id="selectSinvRcvTrxMaxNodeConfig"
            resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxNodeTreeDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srrsm.tenant_id,
        srrsm.rcv_trx_header_id,
        #{rcvTrxLineId} rcv_trx_line_id,
        srsl.line_seq
        FROM
        sinv_rcv_record_strategy_mapping srrsm
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        WHERE
        srrsm.tenant_id = #{tenantId}
        AND srrsm.rcv_trx_header_id = #{rcvTrxHeaderId}
    </select>


    <!--  根据事务头-查询该事务一共存在多少节点 -->
    <select id="selectSinvRcvTrxNodeConfigList"
            resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxNodeTreeChildrenDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srnc.node_config_id,
        srsl.tenant_id,
        srnc.node_order_type,
        srnc.node_config_code,
        srnc.node_config_name,
        srnc.node_config_index,
        srsl.line_seq,
        srsl.strategy_header_id,
        srsl.strategy_line_id
        FROM
        sinv_rcv_strategy_line srsl
        JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        WHERE
        srsl.tenant_id = #{tenantId}
        AND EXISTS (
        SELECT
        1
        FROM
        sinv_rcv_trx_line srtl2
        JOIN sinv_rcv_trx_order_link srto ON srtl2.order_link_id = srto.order_link_id
        JOIN sinv_rcv_record_strategy_mapping srrsm ON srtl2.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl2 ON srrsm.strategy_line_id = srsl2.strategy_line_id
        WHERE
        srtl2.rcv_trx_header_id = #{rcvTrxHeaderId}
        AND srsl2.strategy_header_id = srsl.strategy_header_id)
        order by srsl.line_seq asc
    </select>

    <!--  根据事务来源-查找最初的初始节点的:node_config_id -->
    <select id="selectSinvFirstNodeConfigList"
            resultType="org.srm.purchasecooperation.sinv.api.dto.SinvRcvTrxTreeDTO">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srsl.node_config_id,
        srsl.strategy_line_id,
        srsl.strategy_header_id,
        srnc.node_config_name
        FROM
        sinv_rcv_trx_line srtl
        JOIN sinv_rcv_trx_order_link srto ON srtl.order_link_id = srto.order_link_id
        LEFT JOIN sinv_rcv_trx_header srth ON srtl.rcv_trx_header_id = srth.rcv_trx_header_id
        LEFT JOIN sinv_rcv_record_strategy_mapping srrsm ON srtl.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.next_strategy_line_id = srsl.strategy_line_id
        left JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        WHERE
        srto.tenant_id = #{tenantId}
        AND srtl.delete_flag = 0
        AND srto.source_header_num = #{sourceHeaderNum}
        AND srto.source_line_num = #{sourceLineNum}
        AND srrsm.initial_node_flag = 1
    </select>

    <!--  查询事务剩余节点 -->
    <select id="selectSinvLeftNodeConfig"
            resultType="org.srm.purchasecooperation.sinv.domain.entity.RcvStrategyLine">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srsl2.strategy_line_id,
        srsl2.strategy_header_id,
        srsl2.line_seq,
        srsl2.srm_enable,
        srsl2.subject_type,
        srsl2.last_strategy_line_id,
        srsl2.next_strategy_line_id,
        srsl2.node_config_id,
        srsl2.approve_rule_code,
        srsl2.export_ext_enable,
        srsl2.tenant_id
        FROM
        sinv_rcv_strategy_line srsl2
        JOIN sinv_rcv_node_config srnc ON srsl2.node_config_id = srnc.node_config_id
        WHERE
        srsl2.tenant_id = #{tenantId}
        AND EXISTS (
        SELECT
        srrsm.next_strategy_line_id
        FROM
        sinv_rcv_record_strategy_mapping srrsm
        JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        WHERE
        srrsm.rcv_trx_header_id = #{rcvTrxHeaderId}
        AND srrsm.tenant_id = #{tenantId}
        AND srsl.strategy_header_id = srsl2.strategy_header_id
        AND srsl.line_seq &lt; srsl2.line_seq
        )
    </select>

    <!--  查询事务剩余节点 -->
    <select id="selectFirstNodeConfig"
            resultType="org.srm.purchasecooperation.sinv.domain.entity.RcvNodeConfig">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT srnc.node_order_type,
        srnc.node_config_id
        from sinv_rcv_strategy_line srsl
        JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        where
        srsl.strategy_header_id = #{strategyHeaderId}
        and srsl.tenant_id = #{tenantId}
        and srsl.line_seq = 1
    </select>

    <!--  根据节点查询事务类型id -->
    <select id="selectRcvTrxTypeId" resultType="java.lang.Long">
        SELECT
        srem.mapping_id as rcv_trx_type_id
        FROM
        sinv_rcv_ext_mapping srem
        WHERE
        srem.tenant_id = #{tenantId}
        and srem.node_config_id = #{nodeConfigId}
        and srem.external_system_code = #{externalSystemCode}
        and srem.node_config_type = 1
    </select>

    <!--  根据当前事务对应的节点信息 -->
    <select id="selectRcvTrxNodeConfig"
            resultType="org.srm.purchasecooperation.sinv.domain.entity.RcvNodeConfig">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srnc.node_config_id,
        srnc.node_config_code,
        srnc.node_config_name,
        srtt.rcv_trx_type_code ref_Rcv_Type_Code,
        srnc.node_config_index
        FROM
        sinv_rcv_record_strategy_mapping srrsm
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        LEFT JOIN sinv_rcv_node_config srnc ON srsl.node_config_id = srnc.node_config_id
        LEFT JOIN spfm_rcv_trx_types srtt ON srnc.ref_rcv_type_id = srtt.rcv_trx_type_id
        WHERE
        srrsm.tenant_id = #{tenantId}
        AND srrsm.rcv_trx_header_id = #{rcvTrxHeaderId}
    </select>

    <!--  查询事务当前节点信息 -->
    <select id="selectSinvNowNodeConfig"
            resultType="org.srm.purchasecooperation.sinv.domain.entity.RcvStrategyLine">
        <bind name="lang" value="@io.choerodon.mybatis.helper.LanguageHelper@language()"/>
        SELECT
        srsl.strategy_line_id,
        srsl.line_seq,
        srsl.srm_enable,
        srsl.export_ext_enable,
        srsl.settle_flag,
        srsl.subject_type,
        srsl.approve_rule_code,
        srsl.finance_reverse_code
        FROM
        sinv_rcv_trx_line srtl
        LEFT JOIN sinv_rcv_record_strategy_mapping srrsm ON srtl.rcv_trx_header_id = srrsm.rcv_trx_header_id
        LEFT JOIN sinv_rcv_strategy_line srsl ON srrsm.strategy_line_id = srsl.strategy_line_id
        WHERE
        srtl.tenant_id = #{tenantId}
        AND srtl.rcv_trx_line_id = #{rcvTrxLineId}
    </select>

    <select id="selectSinvRcvTrxHeader" resultType="org.srm.purchasecooperation.sinv.domain.entity.SinvRcvTrxHeader">
        SELECT
            srth.*
        FROM
            sinv_rcv_trx_header srth
            JOIN sinv_rcv_record_strategy_mapping srrsm ON srth.rcv_trx_header_id = srrsm.rcv_trx_header_id
        WHERE
            srth.tenant_id = #{tenantId}
            and srrsm.initial_node_flag = 0
            /*物料查询*/
            <if test="sinvRcvTrxQueryDTO.itemId !=null">
                AND exists (
                SELECT 1 from sinv_rcv_trx_line srtl WHERE srtl.rcv_trx_header_id=srth.rcv_trx_header_id
                    AND srtl.item_id=#{sinvRcvTrxQueryDTO.itemId}
                )
            </if>
           /* 供应商查询*/
           <if test="sinvRcvTrxQueryDTO.supplierCompanyId !=null">
               AND exists (
               SELECT 1 from sinv_rcv_trx_line srtl WHERE srtl.rcv_trx_header_id=srth.rcv_trx_header_id
                    AND srtl.supplier_company_id=#{sinvRcvTrxQueryDTO.supplierCompanyId}
               )
           </if>
           /*物料分类，品类*/
           <if test="sinvRcvTrxQueryDTO.categoryId !=null">
               AND exists (
               SELECT 1 from sinv_rcv_trx_line srtl WHERE srtl.rcv_trx_header_id=srth.rcv_trx_header_id
               AND srtl.category_id=#{sinvRcvTrxQueryDTO.categoryId}
               )
           </if>
        <!-- 事务头id -->
        <if test="sinvRcvTrxQueryDTO.rcvTrxHeaderIds != null">
            and srth.rcv_trx_header_id in
            <foreach collection="sinvRcvTrxQueryDTO.rcvTrxHeaderIds" index="index" item="item" open="(" separator=","
                     close=")">
                #{item}
            </foreach>
        </if>
    </select>
</mapper>
